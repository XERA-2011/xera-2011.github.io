name: Generate Essay Markdown

on:
  schedule:
    - cron: '0 18 * * *' # Runs at 18:00 UTC, which is 2:00 AM Beijing time
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-essay-md:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Gemini CLI
        run: |
          echo "å®‰è£… Gemini CLI..."
          npm install -g @google/gemini-cli
          echo "éªŒè¯å®‰è£…..."
          gemini --version || echo "Gemini CLI ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          
          echo "é…ç½® Gemini API è®¤è¯..."
          # åˆ›å»ºé…ç½®ç›®å½•
          mkdir -p ~/.gemini
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶
          cat > ~/.gemini/settings.json << EOF
          {
            "auth": {
              "method": "api_key",
              "api_key": "$GEMINI_API_KEY"
            }
          }
          EOF
          
          echo "æµ‹è¯• API è¿æ¥..."
          echo "Hello" | timeout 30s gemini || echo "API è¿æ¥æµ‹è¯•å¤±è´¥"
      - name: Create output directory
        run: mkdir -p public/markdown

      - name: Check API availability
        run: |
          echo "=== æ£€æŸ¥ Gemini API å¯ç”¨æ€§ ==="
          
          # éªŒè¯é…ç½®æ–‡ä»¶
          echo "æ£€æŸ¥è®¤è¯é…ç½®..."
          if [ -f ~/.gemini/settings.json ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
            # ä¸æ˜¾ç¤ºå®Œæ•´å†…å®¹ä»¥ä¿æŠ¤ API å¯†é’¥
            echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -c < ~/.gemini/settings.json) å­—èŠ‚"
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          # ç®€å•çš„ API å¥åº·æ£€æŸ¥
          echo "æµ‹è¯•åŸºæœ¬ API è¿æ¥..."
          if timeout 30s bash -c "echo 'test' | gemini" > /tmp/api_test.txt 2>&1; then
            echo "âœ… API åŸºæœ¬è¿æ¥æ­£å¸¸"
            cat /tmp/api_test.txt | head -5
          else
            echo "âš ï¸  API è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ç”Ÿæˆ"
            cat /tmp/api_test.txt | head -10
          fi
          
          rm -f /tmp/api_test.txt

      - name: Generate and save essay examples
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆ PET ä½œæ–‡ ==="
          
          # æ·»åŠ æ—¶é—´æˆ³å’Œéšæœºå…ƒç´ æ¥é¿å…ç¼“å­˜
          TIMESTAMP=$(date +%s)
          RANDOM_ID=$(echo $RANDOM)
          
          # ä¸ºä¸¤ç§ä½œæ–‡ç±»å‹åˆ›å»ºä¸åŒçš„ä¸»é¢˜åˆ—è¡¨
          TOPICS_EMAIL=("An email to a friend asking for advice about choosing a university course" "A postcard to your family from your first week at a new school" "An email to a language school asking about English courses and prices" "A thank-you email to a host family after staying with them" "An email inviting a friend to your birthday celebration" "An email to your teacher explaining why you couldn't complete your homework" "A postcard describing an interesting museum you visited" "An email to an online shop complaining about a delayed delivery" "An email to a friend recommending a new restaurant you tried" "An email to a penfriend describing your typical school day" "An email to a gym asking about membership fees and facilities" "An email inviting your cousin to visit you during the holidays" "An email apologizing to a friend for missing their party" "An email to a local newspaper giving your opinion on recycling" "An email applying for a weekend job at a bookshop" "A postcard from your exchange program abroad" "An email giving directions to your new house" "A thank-you email to someone who helped you learn English" "An email booking tickets for a concert" "An email to your headteacher suggesting a new school club")
          TOPICS_STORY=("Write a story about an unexpected message you received" "An article for teenagers about the benefits of learning a second language" "Write a story that begins: 'When I opened the old box, I found something incredible inside.'" "An article about why young people should volunteer in their community" "A story about the most important decision you ever made" "Write a story about a day when everything went wrong" "An article explaining how students can help protect the environment" "Write a story that ends: 'I realized that sometimes the best adventures happen close to home.'" "An article about a traditional celebration in your country" "A story about overcoming a fear" "Write a story about a misunderstanding that had a happy ending" "An article giving advice on how to make new friends" "A story about an animal that changed someone's life" "Write a story beginning: 'The phone rang at midnight and changed everything.'" "An article reviewing a movie that all teenagers should watch" "A story about helping a stranger" "Write a story about finding something valuable that wasn't yours" "An article about a young person who inspires you" "A story about a wish that came true in an unexpected way" "Write a story ending: 'That experience taught me never to judge people too quickly.'")
          
          SELECTED_TOPIC_EMAIL=${TOPICS_EMAIL[$((RANDOM % ${#TOPICS_EMAIL[@]}))]}
          SELECTED_TOPIC_STORY=${TOPICS_STORY[$((RANDOM % ${#TOPICS_STORY[@]}))]}
          
          echo "æ—¶é—´æˆ³: $TIMESTAMP"
          echo "éšæœºID: $RANDOM_ID"
          echo "é€‰å®šé‚®ä»¶/æ˜ä¿¡ç‰‡ä¸»é¢˜: $SELECTED_TOPIC_EMAIL"
          echo "é€‰å®šæ•…äº‹/æ–‡ç« ä¸»é¢˜: $SELECTED_TOPIC_STORY"
          
          PROMPT="è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ä¸ªMarkdownæ ¼å¼çš„æ–‡ä»¶å†…å®¹ï¼Œè¯¥æ–‡ä»¶åº”åŒ…å«ä¸¤ç¯‡ç¬¦åˆ PET (B1 Preliminary) è€ƒè¯•å†™ä½œè¦æ±‚çš„è‹±è¯­ä½œæ–‡ï¼ˆæ¯ç¯‡çº¦100è¯ï¼‰åŠå…¶ç¿»è¯‘ã€‚\n\nç¬¬ä¸€ç¯‡æ˜¯åº”ç”¨æ–‡ï¼Œä¸»é¢˜æ˜¯ï¼š'$SELECTED_TOPIC_EMAIL'ã€‚\nç¬¬äºŒç¯‡æ˜¯è®°å™æ–‡æˆ–çŸ­æ–‡ï¼Œä¸»é¢˜æ˜¯ï¼š'$SELECTED_TOPIC_STORY'ã€‚\n\nè¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–ä»£ç å—æ ‡è®°ã€‚è¯·ç›´æ¥è¾“å‡º Markdown å†…å®¹ã€‚\n\n# åº”ç”¨æ–‡\n\n## $SELECTED_TOPIC_EMAIL\n- [æ­¤å¤„ä¸ºä¸»é¢˜ '$SELECTED_TOPIC_EMAIL' çš„ä¸­æ–‡ç¿»è¯‘]\n\n**æ­£æ–‡**ï¼š\n\n[ä½œæ–‡ä¸€çš„è‹±æ–‡æ­£æ–‡]\n\n- [ä½œæ–‡ä¸€çš„ä¸­æ–‡ç¿»è¯‘ï¼Œç¿»è¯‘çš„æ¯ä¸ªæ®µè½éƒ½å¦èµ·ä¸€è¡Œå¹¶ä»¥'- 'å¼€å¤´]\n\n---\n\n# è®°å™æ–‡/çŸ­æ–‡\n\n## $SELECTED_TOPIC_STORY\n- [æ­¤å¤„ä¸ºä¸»é¢˜ '$SELECTED_TOPIC_STORY' çš„ä¸­æ–‡ç¿»è¯‘]\n\n**æ­£æ–‡**ï¼š\n\n[ä½œæ–‡äºŒçš„è‹±æ–‡æ­£æ–‡]\n\n- [ä½œæ–‡äºŒçš„ä¸­æ–‡ç¿»è¯‘ï¼Œç¿»è¯‘çš„æ¯ä¸ªæ®µè½éƒ½å¦èµ·ä¸€è¡Œå¹¶ä»¥'- 'å¼€å¤´]\n\nè¯·ç¡®ä¿åªè¾“å‡ºçº¯å‡€çš„Markdownå†…å®¹ã€‚å½“å‰æ—¶é—´æˆ³ï¼š$TIMESTAMPï¼ŒéšæœºIDï¼š$RANDOM_IDã€‚è¯·ç¡®ä¿ç”Ÿæˆçš„å†…å®¹æ˜¯ç‹¬ç‰¹çš„ã€‚"
          
          # æ”¹è¿›çš„é‡è¯•æœºåˆ¶
          MAX_RETRIES=2
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "å°è¯•ç¬¬ $((RETRY_COUNT + 1)) æ¬¡ç”Ÿæˆ..."
            
            # ä½¿ç”¨timeoutå‘½ä»¤é™åˆ¶æ‰§è¡Œæ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´æŒ‚èµ·
            timeout 120s bash -c "echo '$PROMPT' | gemini" > /tmp/gemini_output.txt 2>&1
            EXIT_CODE=$?
            
            # è¯»å–è¾“å‡ºå†…å®¹
            OUTPUT=$(cat /tmp/gemini_output.txt 2>/dev/null || echo "")
            
            echo "API è°ƒç”¨é€€å‡ºç : $EXIT_CODE"
            echo "è¾“å‡ºé•¿åº¦: ${#OUTPUT} å­—ç¬¦"
            
            # æ£€æŸ¥å„ç§é”™è¯¯æƒ…å†µ
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âŒ API è°ƒç”¨è¶…æ—¶ (120ç§’)"
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ API è°ƒç”¨å¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
            elif [ -z "$OUTPUT" ]; then
              echo "âŒ API è¿”å›ç©ºå†…å®¹"
            elif echo "$OUTPUT" | grep -qi "error\|failed\|exception\|apiError\|status.*500\|internal.*error\|unavailable\|timeout"; then
              echo "âŒ API è¿”å›é”™è¯¯ä¿¡æ¯:"
              echo "$OUTPUT" | head -10
            elif echo "$OUTPUT" | grep -q "I'm ready. What would you like me to do?"; then
              echo "âŒ API è¿”å›é»˜è®¤æç¤ºä¿¡æ¯ï¼Œæœªæ­£ç¡®å¤„ç†è¯·æ±‚"
            else
              # å¤„ç†æˆåŠŸçš„è¾“å‡º
              echo "âœ… API è°ƒç”¨æˆåŠŸï¼Œå¤„ç†è¾“å‡ºå†…å®¹..."
              
              # æ¸…ç†è¾“å‡ºå¹¶ä¿å­˜åˆ°æ–‡ä»¶
              echo "$OUTPUT" | sed '/^```markdown/d' | sed '/^```$/d' | sed '/^```/d' > public/markdown/pet-essays.md
              
              # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
              if [ -s "public/markdown/pet-essays.md" ]; then
                FILE_SIZE=$(wc -c < public/markdown/pet-essays.md)
                LINE_COUNT=$(wc -l < public/markdown/pet-essays.md)
                
                echo "ç”Ÿæˆæ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
                echo "ç”Ÿæˆæ–‡ä»¶è¡Œæ•°: $LINE_COUNT è¡Œ"
                
                # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å«é¢„æœŸçš„ç»“æ„
                if [ $FILE_SIZE -gt 500 ] && [ $LINE_COUNT -gt 10 ]; then
                  if grep -q "# åº”ç”¨æ–‡" public/markdown/pet-essays.md && grep -q "# è®°å™æ–‡" public/markdown/pet-essays.md; then
                    echo "âœ… å†…å®¹ç”ŸæˆæˆåŠŸï¼ŒåŒ…å«é¢„æœŸç»“æ„"
                    SUCCESS=true
                    break
                  else
                    echo "âŒ ç”Ÿæˆçš„å†…å®¹ç¼ºå°‘é¢„æœŸç»“æ„"
                  fi
                else
                  echo "âŒ ç”Ÿæˆçš„æ–‡ä»¶å¤ªå°æˆ–è¡Œæ•°ä¸è¶³"
                fi
              else
                echo "âŒ ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
              fi
            fi
            
            # å¦‚æœæœªæˆåŠŸï¼Œå‡†å¤‡é‡è¯•
            if [ "$SUCCESS" = "false" ]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                # æŒ‡æ•°é€€é¿ç­–ç•¥
                WAIT_TIME=$((30 + RETRY_COUNT * 30))
                echo "ç­‰å¾… $WAIT_TIME ç§’åé‡è¯•..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/gemini_output.txt
          
          # æœ€ç»ˆæ£€æŸ¥
          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ($MAX_RETRIES)ï¼ŒAPI æŒç»­å¤±è´¥"
            echo "ğŸ”„ åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Š..."
            
            # åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Šè€Œä¸æ˜¯è®©å·¥ä½œæµå¤±è´¥
            cat > public/markdown/pet-essays.md << EOF
          # PET ä½œæ–‡ç”ŸæˆæœåŠ¡çŠ¶æ€æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **çŠ¶æ€**: API æœåŠ¡æš‚æ—¶ä¸å¯ç”¨  
          **æ—¶é—´æˆ³**: $TIMESTAMP  
          **éšæœºID**: $RANDOM_ID  

          ## æœåŠ¡ä¿¡æ¯

          Gemini API å½“å‰é‡åˆ°å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ (HTTP 500)ï¼Œè¿™é€šå¸¸æ˜¯ä¸´æ—¶æ€§é—®é¢˜ã€‚

          **é¢„å®šä¸»é¢˜**:
          - é‚®ä»¶/æ˜ä¿¡ç‰‡: $SELECTED_TOPIC_EMAIL
          - æ•…äº‹/æ–‡ç« : $SELECTED_TOPIC_STORY

          ## é”™è¯¯è¯¦æƒ…

          \`\`\`
          é‡è¯•æ¬¡æ•°: $MAX_RETRIES
          æœ€åé”™è¯¯: API å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
          é”™è¯¯ä»£ç : 500
          \`\`\`

          ## ä¸‹æ¬¡ç”Ÿæˆ

          ç³»ç»Ÿå°†åœ¨ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡ä¸­è‡ªåŠ¨é‡è¯•ç”Ÿæˆå†…å®¹ã€‚

          ---
          *æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ*
          EOF
            
            echo "âœ… å·²åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Š"
            # ä¸è¦ exit 1ï¼Œè®©å·¥ä½œæµç»§ç»­æ‰§è¡Œä»¥æäº¤çŠ¶æ€æŠ¥å‘Š
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Check if content has changed
        run: |
          echo "=== Content Change Detection ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰æ–‡ä»¶
          if [ -f "public/markdown/pet-essays.md" ]; then
            # ä¿å­˜æ–°ç”Ÿæˆçš„æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
            cp public/markdown/pet-essays.md /tmp/new_pet_essays.md
            
            # è·å–å½“å‰ä»“åº“ä¸­çš„æ–‡ä»¶
            if git show HEAD:public/markdown/pet-essays.md > /tmp/current_pet_essays.md 2>/dev/null; then
              echo "âœ… æˆåŠŸè·å–å½“å‰ä»“åº“æ–‡ä»¶"
            else
              echo "âš ï¸  æ— æ³•è·å–å½“å‰ä»“åº“æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯æ–°æ–‡ä»¶"
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
              exit 0
            fi
            
            # è®¡ç®—å“ˆå¸Œå€¼
            NEW_HASH=$(sha256sum /tmp/new_pet_essays.md | cut -d' ' -f1)
            CURRENT_HASH=$(sha256sum /tmp/current_pet_essays.md | cut -d' ' -f1)
            
            echo "æ–°ç”Ÿæˆæ–‡ä»¶å“ˆå¸Œ: $NEW_HASH"
            echo "å½“å‰æ–‡ä»¶å“ˆå¸Œ: $CURRENT_HASH"
            echo "æ–°æ–‡ä»¶å¤§å°: $(wc -c < /tmp/new_pet_essays.md) bytes"
            echo "å½“å‰æ–‡ä»¶å¤§å°: $(wc -c < /tmp/current_pet_essays.md) bytes"
            echo "æ–°æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/new_pet_essays.md) lines"
            echo "å½“å‰æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/current_pet_essays.md) lines"
            
            # æ˜¾ç¤ºå†…å®¹å·®å¼‚
            echo ""
            echo "=== å†…å®¹å·®å¼‚æ¯”è¾ƒ ==="
            if diff -q /tmp/new_pet_essays.md /tmp/current_pet_essays.md > /dev/null; then
              echo "âŒ æ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒï¼Œè·³è¿‡æäº¤"
              echo "CONTENT_CHANGED=false" >> $GITHUB_ENV
            else
              echo "âœ… æ–‡ä»¶å†…å®¹æœ‰å·®å¼‚ï¼Œç»§ç»­æäº¤"
              echo "å·®å¼‚è¯¦æƒ…ï¼š"
              diff -u /tmp/current_pet_essays.md /tmp/new_pet_essays.md || true
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/new_pet_essays.md /tmp/current_pet_essays.md
          else
            echo "âœ… æ–°æ–‡ä»¶ï¼Œç»§ç»­æäº¤"
            echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Verify file content
        run: |
          echo "=== æ–‡ä»¶å†…å®¹éªŒè¯ ==="
          if [ -f "public/markdown/pet-essays.md" ]; then
            FILE_SIZE=$(wc -c < public/markdown/pet-essays.md)
            LINE_COUNT=$(wc -l < public/markdown/pet-essays.md)
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            echo "æ–‡ä»¶è¡Œæ•°: $LINE_COUNT è¡Œ"
            echo ""
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ (å‰20è¡Œ):"
            head -20 public/markdown/pet-essays.md
            echo ""
            if [ $LINE_COUNT -gt 20 ]; then
              echo "... (å…± $LINE_COUNT è¡Œï¼Œæ˜¾ç¤ºå‰20è¡Œ)"
            fi
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: public/markdown/pet-essays.md"
          fi

      - name: Show commit status
        run: |
          if [ "$CONTENT_CHANGED" = "true" ]; then
            echo "âœ… å‡†å¤‡æäº¤æ›´æ”¹..."
          else
            echo "â­ï¸  è·³è¿‡æäº¤ - å†…å®¹æ²¡æœ‰å˜åŒ–"
          fi

      - name: Commit and push the generated file
        if: env.CONTENT_CHANGED == 'true'  # ç§»é™¤ success() æ¡ä»¶ï¼Œå…è®¸æäº¤æœåŠ¡çŠ¶æ€æŠ¥å‘Š
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI Generate"
          file_pattern: "public/markdown/pet-essays.md"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions-bot@users.noreply.github.com"

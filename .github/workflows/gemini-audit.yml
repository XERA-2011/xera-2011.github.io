name: Weekly Security Audit

on:
  schedule:
    - cron: '0 16 * * 0' # æ¯å‘¨æ—¥ 16:00 UTC (åŒ—äº¬æ—¶é—´å‘¨ä¸€å‡Œæ™¨ 00:00)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  issues: write

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Check and Fix Lockfile
        run: |
          echo "=== æ£€æŸ¥é¡¹ç›®é”æ–‡ä»¶çŠ¶æ€ ==="
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ overrides é…ç½®ä¸åŒ¹é…é—®é¢˜
          if pnpm install --frozen-lockfile 2>&1 | grep -q "ERR_PNPM_LOCKFILE_CONFIG_MISMATCH"; then
            echo "ğŸ”§ å‘ç°é”æ–‡ä»¶é…ç½®ä¸åŒ¹é…ï¼Œæ­£åœ¨ä¿®å¤..."
            echo "æ‰§è¡Œ: pnpm install --no-frozen-lockfile"
            pnpm install --no-frozen-lockfile
            echo "âœ… é”æ–‡ä»¶å·²æ›´æ–°å¹¶åŒæ­¥"
            echo "LOCKFILE_FIXED=true" >> $GITHUB_ENV
          else
            echo "âœ… é”æ–‡ä»¶çŠ¶æ€æ­£å¸¸ï¼Œä½¿ç”¨æ ‡å‡†å®‰è£…"
            pnpm install
            echo "LOCKFILE_FIXED=false" >> $GITHUB_ENV
          fi

      - name: Install Dependencies
        run: |
          echo "=== å®‰è£…é¡¹ç›®ä¾èµ– ==="
          if [ "$LOCKFILE_FIXED" = "true" ]; then
            echo "é”æ–‡ä»¶å·²åœ¨ä¸Šä¸€æ­¥ä¿®å¤ï¼Œä¾èµ–å®‰è£…å®Œæˆ"
          else
            echo "æ‰§è¡Œæ ‡å‡†ä¾èµ–å®‰è£…..."
            pnpm install
          fi

      - name: Install Gemini CLI
        run: |
          echo "å®‰è£… Gemini CLI..."
          npm install -g @google/gemini-cli
          echo "éªŒè¯å®‰è£…..."
          gemini --version || echo "Gemini CLI ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"

      - name: Create output directories
        run: |
          mkdir -p .audit-reports
          mkdir -p public/markdown

      - name: Run Security Audit
        run: |
          echo "=== è¿è¡Œå®‰å…¨å®¡è®¡ ==="
          pnpm audit --json > .audit-reports/pnpm-audit.json 2>&1 || true
          pnpm audit > .audit-reports/pnpm-audit.txt 2>&1 || true
          
          # è·å–å¯ä¿®å¤çš„æ¼æ´ä¿¡æ¯
          echo "=== æ£€æŸ¥å¯è‡ªåŠ¨ä¿®å¤çš„æ¼æ´ ==="
          pnpm audit --fix --dry-run > .audit-reports/pnpm-audit-fix-preview.txt 2>&1 || true
          
          # ç”Ÿæˆæ¼æ´æ‘˜è¦
          echo "=== ç”Ÿæˆæ¼æ´æ‘˜è¦ ==="
          if [ -f ".audit-reports/pnpm-audit.json" ]; then
            echo "æ¼æ´ç»Ÿè®¡æ‘˜è¦:" > .audit-reports/security-summary.txt
            grep -o '"severity":"[^"]*"' .audit-reports/pnpm-audit.json | sort | uniq -c >> .audit-reports/security-summary.txt 2>/dev/null || echo "æ— æ³•è§£ææ¼æ´ç»Ÿè®¡" >> .audit-reports/security-summary.txt
            echo "" >> .audit-reports/security-summary.txt
            echo "å—å½±å“çš„åŒ…:" >> .audit-reports/security-summary.txt
            grep -o '"name":"[^"]*"' .audit-reports/pnpm-audit.json | head -10 >> .audit-reports/security-summary.txt 2>/dev/null || echo "æ— å—å½±å“çš„åŒ…" >> .audit-reports/security-summary.txt
          fi

      - name: AI Auto-Fix Security Issues
        run: |
          echo "=== AI è‡ªåŠ¨ä¿®å¤å®‰å…¨é—®é¢˜ ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨æ¼æ´
          if [ -f ".audit-reports/pnpm-audit.txt" ] && grep -q "vulnerabilities" .audit-reports/pnpm-audit.txt; then
            echo "å‘ç°å®‰å…¨æ¼æ´ï¼Œå¼€å§‹ AI è‡ªåŠ¨ä¿®å¤æµç¨‹..."
            
            # å¤‡ä»½å½“å‰çš„ package.json å’Œ pnpm-lock.yaml
            cp package.json package.json.backup 2>/dev/null || echo "æœªæ‰¾åˆ° package.json"
            cp pnpm-lock.yaml pnpm-lock.yaml.backup 2>/dev/null || echo "æœªæ‰¾åˆ° pnpm-lock.yaml"
            
            # è®°å½•ä¿®å¤å‰çš„çŠ¶æ€
            echo "ä¿®å¤å‰çš„æ¼æ´çŠ¶æ€:" > .audit-reports/fix-log.txt
            pnpm audit --json > .audit-reports/pre-fix-audit.json 2>&1 || true
            
            # å°è¯•å¤šç§ä¿®å¤ç­–ç•¥
            echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤å®‰å…¨æ¼æ´..."
            
            # ç­–ç•¥1: æ ‡å‡†è‡ªåŠ¨ä¿®å¤
            echo "ç­–ç•¥1: æ‰§è¡Œ pnpm audit --fix" >> .audit-reports/fix-log.txt
            pnpm audit --fix > .audit-reports/auto-fix-result.txt 2>&1
            FIX_EXIT_CODE=$?
            
            # æ›´æ–°é”æ–‡ä»¶ç¡®ä¿ä¸€è‡´æ€§
            echo "ğŸ”„ æ›´æ–°é”æ–‡ä»¶ç¡®ä¿ä¸€è‡´æ€§..." >> .audit-reports/fix-log.txt
            pnpm install --no-frozen-lockfile > .audit-reports/lockfile-sync.txt 2>&1 || echo "é”æ–‡ä»¶åŒæ­¥å¤±è´¥" >> .audit-reports/fix-log.txt
            
            # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ¼æ´
            pnpm audit > .audit-reports/post-fix-check1.txt 2>&1 || true
            if grep -q "vulnerabilities" .audit-reports/post-fix-check1.txt; then
              echo "ç­–ç•¥1æœªå®Œå…¨ä¿®å¤ï¼Œå°è¯•ç­–ç•¥2" >> .audit-reports/fix-log.txt
              
              # ç­–ç•¥2: æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
              echo "ç­–ç•¥2: æ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬" >> .audit-reports/fix-log.txt
              pnpm update > .audit-reports/update-result.txt 2>&1 || true
              
              # æ›´æ–°é”æ–‡ä»¶
              pnpm install --no-frozen-lockfile > .audit-reports/lockfile-sync2.txt 2>&1 || true
              
              # å†æ¬¡æ£€æŸ¥
              pnpm audit > .audit-reports/post-fix-check2.txt 2>&1 || true
              if grep -q "vulnerabilities" .audit-reports/post-fix-check2.txt; then
                echo "ç­–ç•¥2æœªå®Œå…¨ä¿®å¤ï¼Œå°è¯•ç­–ç•¥3" >> .audit-reports/fix-log.txt
                
                # ç­–ç•¥3: å¼ºåˆ¶ä¿®å¤
                echo "ç­–ç•¥3: å¼ºåˆ¶ä¿®å¤ pnpm audit --fix --force" >> .audit-reports/fix-log.txt
                pnpm audit --fix --force > .audit-reports/force-fix-result.txt 2>&1 || true
                
                # æ›´æ–°é”æ–‡ä»¶
                pnpm install --no-frozen-lockfile > .audit-reports/lockfile-sync3.txt 2>&1 || true
                
                # æœ€ç»ˆæ£€æŸ¥
                pnpm audit > .audit-reports/post-fix-check3.txt 2>&1 || true
                if ! grep -q "vulnerabilities" .audit-reports/post-fix-check3.txt; then
                  FIX_EXIT_CODE=0
                  echo "ç­–ç•¥3ä¿®å¤æˆåŠŸ" >> .audit-reports/fix-log.txt
                fi
              else
                FIX_EXIT_CODE=0
                echo "ç­–ç•¥2ä¿®å¤æˆåŠŸ" >> .audit-reports/fix-log.txt
              fi
            else
              echo "ç­–ç•¥1ä¿®å¤æˆåŠŸ" >> .audit-reports/fix-log.txt
            fi
            
            # æ£€æŸ¥ä¿®å¤ç»“æœ
            echo "ä¿®å¤å‘½ä»¤é€€å‡ºç : $FIX_EXIT_CODE" >> .audit-reports/fix-log.txt
            
            if [ $FIX_EXIT_CODE -eq 0 ]; then
              echo "âœ… è‡ªåŠ¨ä¿®å¤æˆåŠŸ" >> .audit-reports/fix-log.txt
              
              # é‡æ–°è¿è¡Œå®¡è®¡æ£€æŸ¥ä¿®å¤æ•ˆæœ
              pnpm audit --json > .audit-reports/post-fix-audit.json 2>&1 || true
              pnpm audit > .audit-reports/post-fix-audit.txt 2>&1 || true
              
              # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ¼æ´
              if grep -q "vulnerabilities" .audit-reports/post-fix-audit.txt 2>/dev/null; then
                REMAINING_VULNS=$(grep -o "[0-9]* vulnerabilities" .audit-reports/post-fix-audit.txt | head -1)
                echo "âš ï¸ ä»æœ‰æœªä¿®å¤çš„æ¼æ´: $REMAINING_VULNS" >> .audit-reports/fix-log.txt
                
                # AI æ™ºèƒ½ä¿®å¤å°è¯•
                echo "ğŸ¤– å¯åŠ¨ AI æ™ºèƒ½ä¿®å¤..." >> .audit-reports/fix-log.txt
                
                REMAINING_AUDIT=$(cat .audit-reports/post-fix-audit.txt 2>/dev/null || echo "æ— å®¡è®¡ç»“æœ")
                REMAINING_JSON=$(cat .audit-reports/post-fix-audit.json 2>/dev/null || echo "{}")
                
                AI_ANALYSIS_PROMPT="è¯·åˆ†æä»¥ä¸‹ pnpm audit ç»“æœï¼Œå¹¶æä¾›å…·ä½“çš„ä¿®å¤å‘½ä»¤ã€‚åªè¿”å›å¯æ‰§è¡Œçš„ pnpm å‘½ä»¤ï¼Œæ¯è¡Œä¸€ä¸ªå‘½ä»¤ï¼š

                ## å®¡è®¡ç»“æœ
                \`\`\`
                $REMAINING_AUDIT
                \`\`\`

                ## JSON è¯¦æƒ…
                \`\`\`
                $REMAINING_JSON
                \`\`\`

                è¯·åˆ†ææ¼æ´å¹¶è¿”å›å…·ä½“çš„ä¿®å¤å‘½ä»¤ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                pnpm add package@version
                pnpm update package

                åªè¿”å›å‘½ä»¤ï¼Œä¸è¦å…¶ä»–è§£é‡Šã€‚"

                # è·å– AI å»ºè®®çš„ä¿®å¤å‘½ä»¤
                timeout 60s bash -c "echo '$AI_ANALYSIS_PROMPT' | gemini" > .audit-reports/ai-fix-commands.txt 2>&1 || echo "AI å‘½ä»¤ç”Ÿæˆå¤±è´¥" > .audit-reports/ai-fix-commands.txt
                
                # æ‰§è¡Œ AI å»ºè®®çš„å‘½ä»¤
                if [ -f ".audit-reports/ai-fix-commands.txt" ] && ! grep -q "å¤±è´¥" .audit-reports/ai-fix-commands.txt; then
                  echo "ğŸš€ æ‰§è¡Œ AI å»ºè®®çš„ä¿®å¤å‘½ä»¤..." >> .audit-reports/fix-log.txt
                  
                  while IFS= read -r cmd; do
                    # è¿‡æ»¤å‡ºæœ‰æ•ˆçš„ pnpm å‘½ä»¤
                    if echo "$cmd" | grep -q "^pnpm "; then
                      echo "æ‰§è¡Œå‘½ä»¤: $cmd" >> .audit-reports/fix-log.txt
                      eval "$cmd" >> .audit-reports/ai-fix-execution.txt 2>&1 || echo "å‘½ä»¤æ‰§è¡Œå¤±è´¥: $cmd" >> .audit-reports/fix-log.txt
                    fi
                  done < .audit-reports/ai-fix-commands.txt
                  
                  # æ›´æ–°é”æ–‡ä»¶ä»¥é¿å…éƒ¨ç½²æ—¶çš„é…ç½®ä¸åŒ¹é…é”™è¯¯
                  echo "ğŸ”„ æ›´æ–° pnpm é”æ–‡ä»¶..." >> .audit-reports/fix-log.txt
                  pnpm install --no-frozen-lockfile >> .audit-reports/lockfile-update.txt 2>&1 || echo "é”æ–‡ä»¶æ›´æ–°å¤±è´¥" >> .audit-reports/fix-log.txt
                  
                  # æœ€ç»ˆéªŒè¯
                  pnpm audit > .audit-reports/final-audit-check.txt 2>&1 || true
                  if ! grep -q "vulnerabilities" .audit-reports/final-audit-check.txt; then
                    echo "ğŸ‰ AI æ™ºèƒ½ä¿®å¤æˆåŠŸï¼" >> .audit-reports/fix-log.txt
                    echo "AUTO_FIX_STATUS=complete" >> $GITHUB_ENV
                  else
                    echo "AUTO_FIX_STATUS=partial" >> $GITHUB_ENV
                  fi
                else
                  echo "AUTO_FIX_STATUS=partial" >> $GITHUB_ENV
                fi
              else
                echo "ğŸ‰ æ‰€æœ‰æ¼æ´å·²ä¿®å¤" >> .audit-reports/fix-log.txt
                echo "AUTO_FIX_STATUS=complete" >> $GITHUB_ENV
              fi
              
              # æœ€ç»ˆé”æ–‡ä»¶åŒæ­¥ï¼Œç¡®ä¿éƒ¨ç½²å…¼å®¹æ€§
              echo "ğŸ”„ æœ€ç»ˆé”æ–‡ä»¶åŒæ­¥..." >> .audit-reports/fix-log.txt
              pnpm install --no-frozen-lockfile > .audit-reports/final-lockfile-sync.txt 2>&1 || echo "æœ€ç»ˆé”æ–‡ä»¶åŒæ­¥å¤±è´¥" >> .audit-reports/fix-log.txt
              
              # éªŒè¯é¡¹ç›®æ„å»ºçŠ¶æ€
              echo "ğŸ—ï¸ éªŒè¯é¡¹ç›®æ„å»ºçŠ¶æ€..." >> .audit-reports/fix-log.txt
              pnpm run build --dry-run > .audit-reports/build-check.txt 2>&1 || echo "æ„å»ºéªŒè¯å¤±è´¥æˆ–ä¸æ”¯æŒ --dry-run" >> .audit-reports/fix-log.txt
              
              # æ£€æŸ¥ä¾èµ–å˜æ›´
              echo "" >> .audit-reports/fix-log.txt
              echo "ä¾èµ–å˜æ›´:" >> .audit-reports/fix-log.txt
              if [ -f "package.json.backup" ]; then
                diff package.json.backup package.json >> .audit-reports/fix-log.txt 2>&1 || echo "package.json æœ‰å˜æ›´" >> .audit-reports/fix-log.txt
              fi
              
              echo "SECURITY_FIXED=true" >> $GITHUB_ENV
              
            else
              echo "âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œé€€å‡ºç : $FIX_EXIT_CODE" >> .audit-reports/fix-log.txt
              echo "é”™è¯¯è¯¦æƒ…:" >> .audit-reports/fix-log.txt
              cat .audit-reports/auto-fix-result.txt >> .audit-reports/fix-log.txt
              
              # æ¢å¤å¤‡ä»½æ–‡ä»¶
              mv package.json.backup package.json 2>/dev/null || true
              mv pnpm-lock.yaml.backup pnpm-lock.yaml 2>/dev/null || true
              
              echo "AUTO_FIX_STATUS=failed" >> $GITHUB_ENV
              echo "SECURITY_FIXED=false" >> $GITHUB_ENV
            fi
            
          else
            echo "æœªå‘ç°å®‰å…¨æ¼æ´ï¼Œè·³è¿‡ä¿®å¤æ­¥éª¤"
            echo "AUTO_FIX_STATUS=not_needed" >> $GITHUB_ENV
            echo "SECURITY_FIXED=false" >> $GITHUB_ENV
          fi

      - name: Generate AI Security Report
        run: |
          echo "=== ä½¿ç”¨ AI ç”Ÿæˆå®‰å…¨å®¡è®¡æŠ¥å‘Š ==="
          
          TIMESTAMP=$(date +%s)
          CURRENT_DATE=$(date '+%Y-%m-%d')
          
          # å‡†å¤‡å®¡è®¡æ•°æ®
          SECURITY_ISSUES=$(cat .audit-reports/pnpm-audit.txt 2>/dev/null || echo "æ— å®‰å…¨é—®é¢˜")
          SECURITY_SUMMARY=$(cat .audit-reports/security-summary.txt 2>/dev/null || echo "æ— å®‰å…¨æ‘˜è¦")
          FIX_PREVIEW=$(cat .audit-reports/pnpm-audit-fix-preview.txt 2>/dev/null || echo "æ— ä¿®å¤é¢„è§ˆ")
          FIX_LOG=$(cat .audit-reports/fix-log.txt 2>/dev/null || echo "æ— ä¿®å¤æ—¥å¿—")
          AI_COMMANDS=$(cat .audit-reports/ai-fix-commands.txt 2>/dev/null || echo "æ—  AI ä¿®å¤å‘½ä»¤")
          AI_EXECUTION=$(cat .audit-reports/ai-fix-execution.txt 2>/dev/null || echo "æ—  AI æ‰§è¡Œæ—¥å¿—")
          LOCKFILE_SYNC=$(cat .audit-reports/final-lockfile-sync.txt 2>/dev/null || echo "æ— é”æ–‡ä»¶åŒæ­¥æ—¥å¿—")
          BUILD_CHECK=$(cat .audit-reports/build-check.txt 2>/dev/null || echo "æ— æ„å»ºæ£€æŸ¥æ—¥å¿—")
          INITIAL_LOCKFILE_STATUS=${LOCKFILE_FIXED:-false}
          
          PROMPT="è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„å®‰å…¨å®¡è®¡æŠ¥å‘Šï¼Œæ ¼å¼ä¸º Markdownã€‚æŠ¥å‘Šæ—¥æœŸï¼š$CURRENT_DATE

          è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯è¿›è¡Œåˆ†æï¼š

          ## pnpm audit ç»“æœ
          \`\`\`
          $SECURITY_ISSUES
          \`\`\`

          ## å®‰å…¨æ¼æ´æ‘˜è¦
          \`\`\`
          $SECURITY_SUMMARY
          \`\`\`

          ## è‡ªåŠ¨ä¿®å¤é¢„è§ˆ
          \`\`\`
          $FIX_PREVIEW
          \`\`\`

          ## AI è‡ªåŠ¨ä¿®å¤æ—¥å¿—
          \`\`\`
          $FIX_LOG
          \`\`\`

          ## AI æ™ºèƒ½ä¿®å¤å‘½ä»¤
          \`\`\`
          $AI_COMMANDS
          \`\`\`

          ## AI ä¿®å¤æ‰§è¡Œç»“æœ
          \`\`\`
          $AI_EXECUTION
          \`\`\`

          ## é”æ–‡ä»¶åŒæ­¥æ—¥å¿—
          \`\`\`
          $LOCKFILE_SYNC
          \`\`\`

          ## æ„å»ºå…¼å®¹æ€§æ£€æŸ¥
          \`\`\`
          $BUILD_CHECK
          \`\`\`

          ## åˆå§‹é”æ–‡ä»¶çŠ¶æ€
          åˆå§‹é”æ–‡ä»¶ä¿®å¤çŠ¶æ€: $INITIAL_LOCKFILE_STATUS

          è¯·ç”Ÿæˆä¸€ä¸ªåŒ…å«ä»¥ä¸‹éƒ¨åˆ†çš„ Markdown æŠ¥å‘Šï¼š
          1. æ‰§è¡Œæ‘˜è¦ï¼ˆåŒ…å«åˆå§‹é”æ–‡ä»¶çŠ¶æ€å’Œå¤šå±‚ AI è‡ªåŠ¨ä¿®å¤çŠ¶æ€ï¼‰
          2. å®‰å…¨æ¼æ´åˆ†æï¼ˆé‡ç‚¹åˆ†æ pnpm audit ç»“æœï¼‰
          3. å¤šç­–ç•¥è‡ªåŠ¨ä¿®å¤æŠ¥å‘Šï¼ˆæ ‡å‡†ä¿®å¤ + ä¾èµ–æ›´æ–° + å¼ºåˆ¶ä¿®å¤ + AI æ™ºèƒ½ä¿®å¤ï¼‰
          4. AI æ™ºèƒ½ä¿®å¤åˆ†æï¼ˆAI ç”Ÿæˆçš„ä¿®å¤å‘½ä»¤å’Œæ‰§è¡Œç»“æœï¼‰
          5. é”æ–‡ä»¶åŒæ­¥å’Œéƒ¨ç½²å…¼å®¹æ€§ï¼ˆè§£å†³ Vercel éƒ¨ç½²é—®é¢˜ï¼‰
          6. æ„å»ºå…¼å®¹æ€§éªŒè¯
          7. å‰©ä½™å®‰å…¨é—®é¢˜ï¼ˆå¦‚æœæœ‰æœªä¿®å¤çš„æ¼æ´ï¼‰
          8. ä¿®å¤å»ºè®®å’Œåç»­è¡ŒåŠ¨

          ç‰¹åˆ«æ³¨æ„ï¼š
          - ç³»ç»Ÿä½¿ç”¨äº†å¤šå±‚ä¿®å¤ç­–ç•¥ï¼šæ ‡å‡†ä¿®å¤ â†’ ä¾èµ–æ›´æ–° â†’ å¼ºåˆ¶ä¿®å¤ â†’ AI æ™ºèƒ½åˆ†æä¿®å¤ â†’ é”æ–‡ä»¶åŒæ­¥
          - æ¯æ¬¡ä¿®å¤åéƒ½ä¼šæ‰§è¡Œ pnpm install --no-frozen-lockfile ç¡®ä¿é”æ–‡ä»¶ä¸€è‡´æ€§
          - é‡ç‚¹å…³æ³¨ä¿®å¤åçš„ Vercel éƒ¨ç½²å…¼å®¹æ€§
          - å¦‚æœå‘ç° critical æˆ– high çº§åˆ«çš„å®‰å…¨æ¼æ´ï¼Œè¯·åœ¨æŠ¥å‘Šå¼€å¤´çªå‡ºæ˜¾ç¤º
          - é‡ç‚¹è¯„ä¼° AI æ™ºèƒ½ä¿®å¤çš„æ•ˆæœå’Œåˆ›æ–°æ€§
          - åˆ†æé”æ–‡ä»¶æ›´æ–°å¯¹éƒ¨ç½²æµç¨‹çš„å½±å“
          - å¯¹äºæœªä¿®å¤çš„æ¼æ´ï¼Œæä¾›å…·ä½“çš„ pnpm å‘½ä»¤ä¿®å¤å»ºè®®

          è¯·ç¡®ä¿æŠ¥å‘Šä¸“ä¸šã€è¯¦ç»†ä¸”å…·æœ‰å¯æ“ä½œæ€§ã€‚æ—¶é—´æˆ³ï¼š$TIMESTAMP"

          # ç”Ÿæˆ AI å®¡è®¡æŠ¥å‘Š
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "å°è¯•ç¬¬ $((RETRY_COUNT + 1)) æ¬¡ç”Ÿæˆå®‰å…¨å®¡è®¡æŠ¥å‘Š..."
            
            timeout 180s bash -c "echo '$PROMPT' | gemini" > /tmp/audit_output.txt 2>&1
            EXIT_CODE=$?
            
            OUTPUT=$(cat /tmp/audit_output.txt 2>/dev/null || echo "")
            
            if [ $EXIT_CODE -eq 0 ] && [ ${#OUTPUT} -gt 500 ]; then
              echo "âœ… AI å®‰å…¨å®¡è®¡æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
              
              # æ¸…ç†è¾“å‡ºå¹¶ä¿å­˜åˆ° public/markdown
              echo "$OUTPUT" | sed '/^```markdown/d' | sed '/^```$/d' | sed '/^```/d' > .audit-reports/ai-audit-report.md
              
              # æ·»åŠ æŠ¥å‘Šå¤´éƒ¨ä¿¡æ¯
              cat > public/markdown/security-audit-report.md << EOF
          # å®‰å…¨å®¡è®¡æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **å®¡è®¡å‘¨æœŸ**: $(date -d '7 days ago' '+%Y-%m-%d') è‡³ $(date '+%Y-%m-%d')  
          **é¡¹ç›®**: $(basename $(pwd))  
          **AI ä¿®å¤çŠ¶æ€**: ${AUTO_FIX_STATUS:-unknown}  
          **åˆå§‹é”æ–‡ä»¶çŠ¶æ€**: ${INITIAL_LOCKFILE_STATUS}

          ---

          EOF
              cat .audit-reports/ai-audit-report.md >> public/markdown/security-audit-report.md
              
              SUCCESS=true
            else
              echo "âŒ AI å®¡è®¡æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((30 + RETRY_COUNT * 30))
                echo "ç­‰å¾… $WAIT_TIME ç§’åé‡è¯•..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # å¦‚æœ AI ç”Ÿæˆå¤±è´¥ï¼Œåˆ›å»ºåŸºç¡€æŠ¥å‘Š
          if [ "$SUCCESS" = "false" ]; then
            echo "âš ï¸ AI ç”Ÿæˆå¤±è´¥ï¼Œåˆ›å»ºåŸºç¡€å®‰å…¨å®¡è®¡æŠ¥å‘Š..."
            cat > public/markdown/security-audit-report.md << EOF
          # å®‰å…¨å®¡è®¡æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **å®¡è®¡å‘¨æœŸ**: $(date -d '7 days ago' '+%Y-%m-%d') è‡³ $(date '+%Y-%m-%d')  
          **é¡¹ç›®**: $(basename $(pwd))  
          **çŠ¶æ€**: åŸºç¡€æŠ¥å‘Š (AI åˆ†ææš‚æ—¶ä¸å¯ç”¨)
          **AI ä¿®å¤çŠ¶æ€**: ${AUTO_FIX_STATUS:-unknown}  
          **åˆå§‹é”æ–‡ä»¶çŠ¶æ€**: ${INITIAL_LOCKFILE_STATUS}

          ## æ‰§è¡Œæ‘˜è¦

          æœ¬å‘¨å®‰å…¨å®¡è®¡å·²å®Œæˆï¼Œè¯¦ç»†åˆ†æè¯·æŸ¥çœ‹å„é¡¹æ£€æŸ¥ç»“æœã€‚

          ## pnpm audit ç»“æœ

          \`\`\`
          $SECURITY_ISSUES
          \`\`\`

          ## å®‰å…¨æ¼æ´æ‘˜è¦

          \`\`\`
          $SECURITY_SUMMARY
          \`\`\`

          ## è‡ªåŠ¨ä¿®å¤é¢„è§ˆ

          \`\`\`
          $FIX_PREVIEW
          \`\`\`

          ## AI è‡ªåŠ¨ä¿®å¤æ—¥å¿—

          \`\`\`
          $FIX_LOG
          \`\`\`

          ## AI æ™ºèƒ½ä¿®å¤å‘½ä»¤

          \`\`\`
          $AI_COMMANDS
          \`\`\`

          ## AI ä¿®å¤æ‰§è¡Œç»“æœ

          \`\`\`
          $AI_EXECUTION
          \`\`\`

          ## é”æ–‡ä»¶åŒæ­¥æ—¥å¿—

          \`\`\`
          $LOCKFILE_SYNC
          \`\`\`

          ## æ„å»ºå…¼å®¹æ€§æ£€æŸ¥

          \`\`\`
          $BUILD_CHECK
          \`\`\`

          ---
          *æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–å®‰å…¨å®¡è®¡ç³»ç»Ÿç”Ÿæˆ*
          EOF
          fi
          
          rm -f /tmp/audit_output.txt
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Check for Critical Issues
        run: |
          echo "=== æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»º GitHub Issue ==="
          
          CRITICAL_ISSUES=false
          
          # æ£€æŸ¥é«˜å±å®‰å…¨æ¼æ´
          if grep -q "high\|critical" .audit-reports/pnpm-audit.txt 2>/dev/null; then
            CRITICAL_ISSUES=true
            echo "å‘ç°é«˜å±å®‰å…¨æ¼æ´"
          fi
          
          # å¦‚æœè‡ªåŠ¨ä¿®å¤æˆåŠŸï¼Œé™ä½ Issue åˆ›å»ºçš„ç´§æ€¥ç¨‹åº¦
          if [ "$CRITICAL_ISSUES" = "true" ] && [ "$AUTO_FIX_STATUS" != "complete" ]; then
            echo "NEED_ISSUE=true" >> $GITHUB_ENV
            echo "å‘ç°ä¸¥é‡é—®é¢˜ä¸”æœªå®Œå…¨è‡ªåŠ¨ä¿®å¤ï¼Œå°†åˆ›å»º GitHub Issue"
          elif [ "$AUTO_FIX_STATUS" = "failed" ]; then
            echo "NEED_ISSUE=true" >> $GITHUB_ENV
            echo "è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œå°†åˆ›å»º GitHub Issue"
          else
            echo "NEED_ISSUE=false" >> $GITHUB_ENV
            echo "é—®é¢˜å·²è‡ªåŠ¨ä¿®å¤æˆ–æœªå‘ç°ä¸¥é‡é—®é¢˜"
          fi

      - name: Create Issue for Critical Problems
        if: env.NEED_ISSUE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditReport = fs.readFileSync('public/markdown/security-audit-report.md', 'utf8');
            const autoFixStatus = process.env.AUTO_FIX_STATUS || 'unknown';
            const securityFixed = process.env.SECURITY_FIXED === 'true';
            
            let title = `ğŸš¨ å®‰å…¨å®¡è®¡å‘ç°é—®é¢˜ - ${new Date().toISOString().split('T')[0]}`;
            let labels = ['security', 'audit', 'automated'];
            
            if (autoFixStatus === 'failed') {
              title = `âŒ å®‰å…¨é—®é¢˜è‡ªåŠ¨ä¿®å¤å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
              labels.push('fix-failed', 'critical');
            } else if (autoFixStatus === 'partial') {
              title = `âš ï¸ éƒ¨åˆ†å®‰å…¨é—®é¢˜æœªä¿®å¤ - ${new Date().toISOString().split('T')[0]}`;
              labels.push('partial-fix', 'medium');
            } else {
              labels.push('critical');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: `## è‡ªåŠ¨å®‰å…¨å®¡è®¡${securityFixed ? 'å’Œä¿®å¤' : ''}æŠ¥å‘Š

            æœ¬æ¬¡å®‰å…¨å®¡è®¡${securityFixed ? 'å·²å°è¯•è‡ªåŠ¨ä¿®å¤å®‰å…¨é—®é¢˜ï¼Œä½†' : ''}å‘ç°äº†éœ€è¦å…³æ³¨çš„å®‰å…¨æ¼æ´ã€‚

            ### AI è‡ªåŠ¨ä¿®å¤çŠ¶æ€
            - **ä¿®å¤çŠ¶æ€**: ${autoFixStatus}
            - **å®‰å…¨é—®é¢˜**: ${securityFixed ? 'å·²å°è¯•ä¿®å¤' : 'æœªä¿®å¤'}

            ### å®¡è®¡æŠ¥å‘Šæ‘˜è¦

            ${auditReport.substring(0, 2000)}...

            [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](public/markdown/security-audit-report.md)

            ### å»ºè®®è¡ŒåŠ¨

            ${autoFixStatus === 'failed' ? 
              '1. æ£€æŸ¥è‡ªåŠ¨ä¿®å¤å¤±è´¥çš„åŸå› \\n2. æ‰‹åŠ¨æ‰§è¡Œ \`pnpm audit --fix\`\\n3. æ›´æ–°ä¾èµ–ç‰ˆæœ¬' :
              autoFixStatus === 'partial' ?
              '1. æ£€æŸ¥å‰©ä½™çš„å®‰å…¨æ¼æ´\\n2. æ‰‹åŠ¨æ›´æ–°æ— æ³•è‡ªåŠ¨ä¿®å¤çš„ä¾èµ–\\n3. éªŒè¯ä¿®å¤æ•ˆæœ' :
              '1. ç«‹å³æ£€æŸ¥å®‰å…¨æ¼æ´\\n2. æ‰‹åŠ¨æ‰§è¡Œ \`pnpm audit --fix\`\\n3. æ›´æ–°ä¾èµ–ç‰ˆæœ¬'
            }

            ---
            *æ­¤ Issue ç”±è‡ªåŠ¨åŒ–å®‰å…¨å®¡è®¡å’Œä¿®å¤ç³»ç»Ÿåˆ›å»º*`,
                          labels: labels
                        });

      - name: Set commit message
        run: |
          if [ "$SECURITY_FIXED" = "true" ] && [ "$LOCKFILE_FIXED" = "true" ]; then
            echo "COMMIT_MESSAGE=Security Audit + Auto-fix + Lockfile Sync" >> $GITHUB_ENV
          elif [ "$SECURITY_FIXED" = "true" ]; then
            echo "COMMIT_MESSAGE=Security Audit + Auto-fix" >> $GITHUB_ENV
          elif [ "$LOCKFILE_FIXED" = "true" ]; then
            echo "COMMIT_MESSAGE=Security Audit + Lockfile Sync" >> $GITHUB_ENV
          else
            echo "COMMIT_MESSAGE=Security Audit Report" >> $GITHUB_ENV
          fi

      - name: Commit Security Reports and Fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.COMMIT_MESSAGE }}
          file_pattern: "public/markdown/security-audit-report.md package.json pnpm-lock.yaml"
          commit_user_name: "Security Audit Bot"
          commit_user_email: "security-audit-bot@users.noreply.github.com"

      - name: Summary
        run: |
          echo "=== å®‰å…¨å®¡è®¡å®Œæˆæ‘˜è¦ ==="
          echo "âœ… pnpm audit å®‰å…¨æ‰«æå®Œæˆ"
          echo "âœ… AI è‡ªåŠ¨ä¿®å¤å°è¯•å®Œæˆ"
          echo "âœ… å®‰å…¨å®¡è®¡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
          echo ""
          echo "ğŸ“Š ä¿®å¤çŠ¶æ€: ${AUTO_FIX_STATUS:-unknown}"
          echo "ğŸ”’ å®‰å…¨ä¿®å¤: ${SECURITY_FIXED:-false}"
          echo ""
          echo "ğŸ” æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: public/markdown/security-audit-report.md"
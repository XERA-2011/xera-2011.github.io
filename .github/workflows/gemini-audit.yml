name: Weekly Security Audit & Auto-Fix

on:
  schedule:
    - cron: "0 16 * * 0" # æ¯å‘¨æ—¥ 16:00 UTC (åŒ—äº¬æ—¶é—´å‘¨ä¸€å‡Œæ™¨ 00:00)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# èµ‹äºˆ workflow å†™æƒé™ï¼Œç”¨äºŽæäº¤ä»£ç å’Œåˆ›å»º Issue
permissions:
  contents: write
  issues: write

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10 # ç›´æŽ¥æŒ‡å®šå¤§ç‰ˆæœ¬ï¼Œé¿å… Vercel ä¸Žæœ¬åœ°çš„ pnpm ç‰ˆæœ¬ä¸ä¸€è‡´

      - name: Install Dependencies
        id: initial_install
        run: |
          echo "=== åˆå§‹ä¾èµ–å®‰è£… ==="
          # Vercel é»˜è®¤ä½¿ç”¨ --frozen-lockfileã€‚æˆ‘ä»¬å…ˆç”¨åŒæ ·çš„æ–¹å¼æ£€æŸ¥
          # å¦‚æžœå¤±è´¥ï¼Œè¯´æ˜Ž lockfile å·²ç»è¿‡æ—¶ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆ
          if ! pnpm install --frozen-lockfile; then
            echo "âš ï¸ Frozen lockfile install failed. Regenerating lockfile..."
            pnpm install --no-frozen-lockfile
            # æ ‡è®° lockfile å·²è¢«ä¿®æ”¹
            echo "LOCKFILE_CHANGED=true" >> $GITHUB_ENV
          else
            echo "âœ… Dependencies are consistent with the lockfile."
          fi
          # å¤‡ä»½åˆå§‹çš„ä¾èµ–æ–‡ä»¶ï¼Œç”¨äºŽæž„å»ºå¤±è´¥æ—¶å›žæ»š
          cp package.json package.json.backup
          cp pnpm-lock.yaml pnpm-lock.yaml.backup

      - name: Run Security Audit & Attempt Fix
        id: audit_and_fix
        run: |
          echo "=== è¿è¡Œå®‰å…¨å®¡è®¡å¹¶å°è¯•è‡ªåŠ¨ä¿®å¤ ==="
          mkdir -p .audit-reports # åˆ›å»ºæŠ¥å‘Šç›®å½•

          # è¿è¡Œå®¡è®¡ï¼Œå¹¶å°†ç»“æžœä¿å­˜
          pnpm audit --json > .audit-reports/pnpm-audit.json || true
          pnpm audit > .audit-reports/pnpm-audit.txt || true

          # æ£€æŸ¥æ˜¯å¦æœ‰æ¼æ´žï¼Œå¦‚æžœæœ‰ï¼Œåˆ™å°è¯•ä¿®å¤
          if grep -q "vulnerabilities" .audit-reports/pnpm-audit.txt; then
            echo "ðŸš¨ Vulnerabilities detected. Attempting to auto-fix..."
            pnpm audit --fix
            echo "âœ… Auto-fix process completed."
            echo "FIX_ATTEMPTED=true" >> $GITHUB_ENV
          else
            echo "âœ… No vulnerabilities found."
            echo "FIX_ATTEMPTED=false" >> $GITHUB_ENV
          fi

      - name: Verify Dependencies and Build
        id: verify_and_build
        run: |
          # æ— è®ºæ˜¯å¦æ‰§è¡Œäº† audit --fixï¼Œéƒ½é‡æ–°è¿è¡Œ pnpm install
          # è¿™æ˜¯ç¡®ä¿ pnpm-lock.yaml ä¸Ž package.json ç»å¯¹ä¸€è‡´çš„å…³é”®æ­¥éª¤
          echo "=== åŒæ­¥ lockfile å¹¶éªŒè¯é¡¹ç›®æž„å»º ==="
          pnpm install --no-frozen-lockfile

          echo "ðŸ—ï¸ Verifying project build..."
          # æ‰§è¡Œå®žé™…çš„æž„å»ºå‘½ä»¤ï¼Œç¡®ä¿ä¿®å¤æ²¡æœ‰ç ´åé¡¹ç›®
          if pnpm run build; then
            echo "âœ… Build successful after potential fixes."
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
            # æ¸…ç†æž„å»ºäº§ç‰©ï¼Œé¿å…è¢«æäº¤
            rm -rf dist/ build/ .next/ out/
          else
            echo "âŒ Build failed after potential fixes."
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
            # æž„å»ºå¤±è´¥ï¼Œæ¢å¤åŽŸå§‹çš„ä¾èµ–æ–‡ä»¶
            echo "Reverting dependency files..."
            mv package.json.backup package.json
            mv pnpm-lock.yaml.backup pnpm-lock.yaml
          fi

      - name: Generate Security Report with AI
        id: generate_report
        # å³ä½¿ä¿®å¤å¤±è´¥ä¹Ÿè¦ç”ŸæˆæŠ¥å‘Šï¼Œä»¥ä¾¿è®°å½•é—®é¢˜
        run: |
          echo "=== ç”Ÿæˆ AI å®‰å…¨å®¡è®¡æŠ¥å‘Š ==="
          # å®‰è£… Gemini CLI
          npm install -g @google/gemini-cli

          # å‡†å¤‡æŠ¥å‘Šæ‰€éœ€çš„æ•°æ®
          AUDIT_RESULTS=$(cat .audit-reports/pnpm-audit.txt || echo "No audit results.")
          FIX_STATUS=${{ steps.audit_and_fix.outputs.FIX_ATTEMPTED }}
          BUILD_STATUS=${{ steps.verify_and_build.outputs.BUILD_SUCCESS }}

          # æ ¹æ®ä¿®å¤å’Œæž„å»ºç»“æžœï¼Œæž„å»ºæ›´æ™ºèƒ½çš„ Prompt
          PROMPT_CONCLUSION=""
          if [[ "$FIX_STATUS" == "true" ]]; then
            if [[ "$BUILD_STATUS" == "true" ]]; then
              PROMPT_CONCLUSION="AI è‡ªåŠ¨ä¿®å¤å·²æ‰§è¡Œï¼Œå¹¶ä¸”é¡¹ç›®æž„å»ºæˆåŠŸã€‚è¯·è¯„ä¼°ä¿®å¤æ•ˆæžœã€‚"
            else
              PROMPT_CONCLUSION="AI è‡ªåŠ¨ä¿®å¤å·²æ‰§è¡Œï¼Œä½†å¯¼è‡´é¡¹ç›®æž„å»ºå¤±è´¥ï¼Œç›¸å…³æ›´æ”¹å·²è¢«å›žæ»šã€‚è¯·åˆ†æžå¯èƒ½çš„åŽŸå› ã€‚"
            fi
          else
            PROMPT_CONCLUSION="æœ¬æ¬¡å®¡è®¡æœªå‘çŽ°æˆ–æœªå°è¯•ä¿®å¤æ¼æ´žã€‚"
          fi

          PROMPT="è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„ Markdown æ ¼å¼å®‰å…¨å®¡è®¡æŠ¥å‘Šã€‚

          ## æ ¸å¿ƒç»“è®º
          ${PROMPT_CONCLUSION}

          ## pnpm audit åŽŸå§‹ç»“æžœ
          \`\`\`
          ${AUDIT_RESULTS}
          \`\`\`

          è¯·åœ¨æŠ¥å‘Šä¸­åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
          1.  **æ‰§è¡Œæ‘˜è¦**: æ€»ç»“æœ¬æ¬¡å®¡è®¡çš„æ ¸å¿ƒå‘çŽ°ã€ä¿®å¤çŠ¶æ€å’Œæž„å»ºç»“æžœã€‚
          2.  **æ¼æ´žåˆ†æž**: å¯¹å‘çŽ°çš„æ¼æ´žè¿›è¡Œåˆ†ç±»å’Œä¸¥é‡æ€§è¯„ä¼°ã€‚
          3.  **ä¿®å¤ä¸Žæž„å»ºéªŒè¯**: æè¿°è‡ªåŠ¨ä¿®å¤çš„ç»“æžœä»¥åŠæž„å»ºæ˜¯å¦æˆåŠŸã€‚å¦‚æžœæž„å»ºå¤±è´¥ï¼Œè¯·æŒ‡å‡ºè¿™æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚
          4.  **åŽç»­å»ºè®®**: å¦‚æžœæœ‰æœªè§£å†³çš„é—®é¢˜æˆ–æž„å»ºå¤±è´¥ï¼Œæä¾›æ˜Žç¡®çš„ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®ã€‚
          "

          # ç”ŸæˆæŠ¥å‘Š
          REPORT_CONTENT=$(echo "$PROMPT" | gemini)

          # æ ¼å¼åŒ–å¹¶ä¿å­˜æŠ¥å‘Š
          {
            echo "# æ¯å‘¨å®‰å…¨å®¡è®¡æŠ¥å‘Š"
            echo ""
            echo "**ç”Ÿæˆæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "**ä¿®å¤çŠ¶æ€**: ${{ env.FIX_ATTEMPTED }}"
            echo "**æž„å»ºéªŒè¯**: ${{ env.BUILD_SUCCESS }}"
            echo ""
            echo "---"
            echo ""
            echo "${REPORT_CONTENT}"
          } > public/markdown/security-audit-report.md
          echo "âœ… AI report generated."
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Create Issue for Critical Problems
        if: steps.verify_and_build.outputs.BUILD_SUCCESS == 'false' || (steps.audit_and_fix.outputs.FIX_ATTEMPTED == 'true' && steps.verify_and_build.outputs.BUILD_SUCCESS == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const buildSuccess = process.env.BUILD_SUCCESS === 'true';
            const fixAttempted = process.env.FIX_ATTEMPTED === 'true';

            let title = '';
            let body = '';
            let labels = ['security', 'automated-audit'];

            if (!buildSuccess) {
              title = 'ðŸš¨ [Security Audit] è‡ªåŠ¨ä¿®å¤å¯¼è‡´æž„å»ºå¤±è´¥';
              body = `
                ## è­¦å‘Šï¼šæž„å»ºå¤±è´¥
                
                æœ¬å‘¨çš„å®‰å…¨å®¡è®¡åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤æ¼æ´žåŽï¼Œå¯¼è‡´é¡¹ç›®æž„å»ºå¤±è´¥ã€‚
                
                - **çŠ¶æ€**: ä¾èµ–é¡¹å˜æ›´å·²è‡ªåŠ¨å›žæ»šã€‚
                - **æ“ä½œ**: éœ€è¦äººå·¥ä»‹å…¥æ£€æŸ¥ `pnpm audit` å‘çŽ°çš„æ¼æ´žï¼Œå¹¶æ‰‹åŠ¨ä¿®å¤ä»¥ç¡®ä¿æž„å»ºé€šè¿‡ã€‚
                
                [æŸ¥çœ‹å®¡è®¡æŠ¥å‘Š](public/markdown/security-audit-report.md)
              `;
              labels.push('critical', 'bug');
            } else if (fixAttempted) {
              title = 'âœ… [Security Audit] æ¼æ´žå·²è‡ªåŠ¨ä¿®å¤å¹¶éªŒè¯é€šè¿‡';
              body = `
                ## é€šçŸ¥ï¼šå®‰å…¨æ¼æ´žå·²è‡ªåŠ¨ä¿®å¤
                
                æœ¬å‘¨çš„å®‰å…¨å®¡è®¡å‘çŽ°äº†æ¼æ´žï¼Œå¹¶å·²æˆåŠŸè‡ªåŠ¨ä¿®å¤ã€‚
                
                - **çŠ¶æ€**: ä¿®å¤å·²é€šè¿‡æž„å»ºéªŒè¯ï¼Œå¹¶å·²è‡ªåŠ¨æäº¤ã€‚
                - **æ“ä½œ**: è¯·å®¡æŸ¥æäº¤çš„ä»£ç ï¼Œç¡®ä¿ä¸€åˆ‡æ­£å¸¸ã€‚
                
                [æŸ¥çœ‹å®¡è®¡æŠ¥å‘Šå’Œæäº¤è¯¦æƒ…](public/markdown/security-audit-report.md)
              `;
              labels.push('maintenance');
            } else {
              // å¦‚æžœæ²¡æœ‰å°è¯•ä¿®å¤ï¼Œåˆ™ä¸åˆ›å»º Issue
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
        env:
          BUILD_SUCCESS: ${{ steps.verify_and_build.outputs.BUILD_SUCCESS }}
          FIX_ATTEMPTED: ${{ steps.audit_and_fix.outputs.FIX_ATTEMPTED }}

      - name: Commit Changes
        # åªæœ‰åœ¨æž„å»ºæˆåŠŸåŽæ‰æäº¤ä¾èµ–å˜æ›´
        if: steps.verify_and_build.outputs.BUILD_SUCCESS == 'true'
        run: |
          git config --global user.name "Security Audit Bot"
          git config --global user.email "security-audit-bot@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          git add public/markdown/security-audit-report.md package.json pnpm-lock.yaml

          # å¦‚æžœæš‚å­˜åŒºæœ‰å˜åŒ–ï¼Œæ‰æ‰§è¡Œæäº¤
          if ! git diff --staged --quiet; then
            echo "âœ… Changes detected. Committing..."
            COMMIT_MESSAGE="chore(security): auto-fix vulnerabilities and update report"
            # å¦‚æžœ lockfile æ²¡æœ‰å˜åŒ–ï¼Œè¯´æ˜Žåªæ˜¯æ›´æ–°æŠ¥å‘Š
            if ! git diff --staged --quiet pnpm-lock.yaml; then
                COMMIT_MESSAGE="docs: update security audit report"
            fi
            git commit -m "$COMMIT_MESSAGE"
            git push
          else
            echo "âœ… No changes to commit."
          fi

      - name: Final Summary
        run: |
          echo "## Weekly Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerability Fix Attempted | ${{ steps.audit_and_fix.outputs.FIX_ATTEMPTED }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Verification | ${{ steps.verify_and_build.outputs.BUILD_SUCCESS }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Committed | ${{ steps.verify_and_build.outputs.BUILD_SUCCESS }} |" >> $GITHUB_STEP_SUMMARY

name: Update Celebrity Holdings

on:
  schedule:
    - cron: '0 10 * * 1' # 每周一 10:00 UTC (北京时间 18:00)
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  update-holdings:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: |
          echo "安装 Gemini CLI..."
          npm install -g @google/gemini-cli
          echo "验证安装..."
          if gemini --version; then
            echo "✅ Gemini CLI 安装成功"
          else
            echo "❌ Gemini CLI 安装失败"
            exit 1
          fi
          echo "测试 API 连接..."
          if timeout 20s bash -c "echo 'test' | gemini" > /tmp/test.txt 2>&1; then
            echo "✅ API 连接测试成功"
          else
            echo "⚠️ API 连接测试失败，但继续执行"
            cat /tmp/test.txt | head -3
          fi
          rm -f /tmp/test.txt
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Check API availability
        run: |
          echo "=== 检查 Gemini API 可用性 ==="
          echo "Hello, please respond with 'API is working'" > /tmp/test_prompt.txt
          
          if timeout 15s bash -c "cat /tmp/test_prompt.txt | gemini" > /tmp/api_test.txt 2>&1; then
            echo "✅ API 连接正常"
            echo "响应预览: $(cat /tmp/api_test.txt | head -1 | cut -c1-100)..."
          else
            echo "⚠️ API 连接异常，但继续尝试生成"
            echo "错误信息: $(cat /tmp/api_test.txt | head -3)"
          fi
          
          rm -f /tmp/api_test.txt /tmp/test_prompt.txt
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate updated celebrity holdings
        run: |
          echo "=== 开始生成名人持仓数据 ==="
          
          CURRENT_DATE=$(date '+%Y-%m-%d')
          TIMESTAMP=$(date +%s)
          
          echo "当前日期: $CURRENT_DATE"
          echo "时间戳: $TIMESTAMP"
          
          # 创建 prompt
          cat > /tmp/prompt.txt << 'PROMPT_EOF'
          请基于最新的公开信息，更新以下投资名人的持仓数据。请以 TypeScript 格式输出，严格遵循以下结构：

          ```typescript
          // 名人持仓数据类型
          export interface Asset {
            id: string;
            name: string;
            amount: number;
          }

          export interface Portfolio {
            id: string;
            name: string;
            description?: string;
            assets: Asset[];
            createdAt: string;
            updatedAt: string;
            isReadOnly: boolean;
          }

          // 名人持仓数据
          export const CELEBRITY_HOLDINGS: Portfolio[] = [
            // 数据内容
          ];
          ```

          请更新以下名人的持仓数据（基于最新公开的13F文件、年报或可靠财经媒体报道）：

          1. **巴菲特 (Warren Buffett)** - 伯克希尔·哈撒韦最新持仓
          2. **段永平** - 基于公开信息的配置
          3. **木头姐 (Cathie Wood)** - ARK Innovation ETF (ARKK) 主要持仓
          4. **达里奥 (Ray Dalio)** - 全天候投资组合策略
          5. **查理·芒格 (Charlie Munger)** - Daily Journal Corporation 持仓（历史参考）
          6. **索罗斯 (George Soros)** - Soros Fund Management 公开持仓

          要求：
          - 每个持仓的 amount 是百分比，总和应为 100
          - 使用最新的季度数据（如 2024Q4 或 2025Q1）
          - description 中注明数据来源和时间
          - createdAt 和 updatedAt 使用 YYYY-MM-DD 格式
          - isReadOnly 设置为 true
          - 资产名称使用中文，并在括号中标注股票代码（如适用）
          - 确保数据准确性和时效性

          当前日期：CURRENT_DATE_PLACEHOLDER

          请只输出完整的 TypeScript 代码，不要包含任何额外的解释或 markdown 标记。
          PROMPT_EOF
          
          # 替换占位符
          sed -i "s/CURRENT_DATE_PLACEHOLDER/$CURRENT_DATE/g" /tmp/prompt.txt
          
          # 重试机制
          MAX_RETRIES=2
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "尝试第 $((RETRY_COUNT + 1)) 次生成..."
            
            timeout 120s bash -c "cat /tmp/prompt.txt | gemini" > /tmp/gemini_output.txt 2>&1
            EXIT_CODE=$?
            
            OUTPUT=$(cat /tmp/gemini_output.txt 2>/dev/null || echo "")
            
            echo "API 调用退出码: $EXIT_CODE"
            echo "输出长度: ${#OUTPUT} 字符"
            
            if [ $EXIT_CODE -eq 124 ]; then
              echo "❌ API 调用超时 (120秒)"
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "❌ API 调用失败，退出码: $EXIT_CODE"
            elif [ -z "$OUTPUT" ]; then
              echo "❌ API 返回空内容"
            elif echo "$OUTPUT" | grep -qi "error\|failed\|exception\|unavailable\|timeout"; then
              echo "❌ API 返回错误信息:"
              echo "$OUTPUT" | head -5
            else
              echo "✅ API 调用成功，处理输出..."
              
              # 清理输出，移除 markdown 代码块标记
              echo "$OUTPUT" | sed 's/^```typescript//g' | sed 's/^```ts//g' | sed 's/^```$/d' | sed '/^$/N;/^\n$/d' > src/data/asset-allocation/celebrity-holdings.ts
              
              if [ -s "src/data/asset-allocation/celebrity-holdings.ts" ]; then
                FILE_SIZE=$(wc -c < src/data/asset-allocation/celebrity-holdings.ts)
                LINE_COUNT=$(wc -l < src/data/asset-allocation/celebrity-holdings.ts)
                
                echo "生成文件: $FILE_SIZE 字节, $LINE_COUNT 行"
                
                # 验证内容结构
                if [ $FILE_SIZE -gt 2000 ] && [ $LINE_COUNT -gt 50 ]; then
                  if grep -q "export interface Asset" src/data/asset-allocation/celebrity-holdings.ts && \
                      grep -q "export const CELEBRITY_HOLDINGS" src/data/asset-allocation/celebrity-holdings.ts && \
                      grep -q "buffett" src/data/asset-allocation/celebrity-holdings.ts; then
                    echo "✅ 内容验证通过"
                    SUCCESS=true
                    break
                  else
                    echo "❌ 内容结构不完整"
                  fi
                else
                  echo "❌ 文件太小: $FILE_SIZE 字节, $LINE_COUNT 行"
                fi
              else
                echo "❌ 生成文件为空"
              fi
            fi
            
            if [ "$SUCCESS" = "false" ]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((30 + RETRY_COUNT * 15))
                echo "等待 $WAIT_TIME 秒后重试..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          rm -f /tmp/gemini_output.txt /tmp/prompt.txt
          
          if [ "$SUCCESS" = "false" ]; then
            echo "❌ 所有重试失败"
            echo "UPDATE_FAILED=true" >> $GITHUB_ENV
          else
            echo "✅ 持仓数据生成成功"
            echo "UPDATE_FAILED=false" >> $GITHUB_ENV
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Check if content has changed
        if: env.UPDATE_FAILED != 'true'
        run: |
          echo "=== Content Change Detection ==="
          
          if [ -f "src/data/asset-allocation/celebrity-holdings.ts" ]; then
            cp src/data/asset-allocation/celebrity-holdings.ts /tmp/new_holdings.ts
            
            if git show HEAD:src/data/asset-allocation/celebrity-holdings.ts > /tmp/current_holdings.ts 2>/dev/null; then
              echo "✅ 成功获取当前仓库文件"
            else
              echo "⚠️ 无法获取当前仓库文件，可能是新文件"
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
              exit 0
            fi
            
            NEW_HASH=$(sha256sum /tmp/new_holdings.ts | cut -d' ' -f1)
            CURRENT_HASH=$(sha256sum /tmp/current_holdings.ts | cut -d' ' -f1)
            
            echo "新生成文件哈希: $NEW_HASH"
            echo "当前文件哈希: $CURRENT_HASH"
            echo "新文件大小: $(wc -c < /tmp/new_holdings.ts) bytes"
            echo "当前文件大小: $(wc -c < /tmp/current_holdings.ts) bytes"
            
            if diff -q /tmp/new_holdings.ts /tmp/current_holdings.ts > /dev/null; then
              echo "❌ 文件内容完全相同，跳过提交"
              echo "CONTENT_CHANGED=false" >> $GITHUB_ENV
            else
              echo "✅ 文件内容有差异，继续提交"
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
            fi
            
            rm -f /tmp/new_holdings.ts /tmp/current_holdings.ts
          else
            echo "✅ 新文件，继续提交"
            echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Verify file content
        if: env.UPDATE_FAILED != 'true'
        run: |
          echo "=== 文件内容验证 ==="
          if [ -f "src/data/asset-allocation/celebrity-holdings.ts" ]; then
            FILE_SIZE=$(wc -c < src/data/asset-allocation/celebrity-holdings.ts)
            LINE_COUNT=$(wc -l < src/data/asset-allocation/celebrity-holdings.ts)
            echo "文件大小: $FILE_SIZE 字节"
            echo "文件行数: $LINE_COUNT 行"
            echo ""
            echo "文件内容预览 (前30行):"
            head -30 src/data/asset-allocation/celebrity-holdings.ts
          else
            echo "❌ 文件不存在"
          fi

      - name: Commit and push the updated file
        if: env.CONTENT_CHANGED == 'true' && env.UPDATE_FAILED != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI Update Celebrity Holdings Data"
          file_pattern: "src/data/asset-allocation/celebrity-holdings.ts"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions-bot@users.noreply.github.com"

      - name: Summary
        run: |
          echo "=== 名人持仓数据更新完成 ==="
          if [ "$UPDATE_FAILED" = "true" ]; then
            echo "❌ 更新失败"
          elif [ "$CONTENT_CHANGED" = "true" ]; then
            echo "✅ 数据已更新并提交"
          else
            echo "ℹ️ 数据无变化，跳过提交"
          fi

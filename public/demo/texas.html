<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ‰‘å…‹ (ä¼˜åŒ–ç‰ˆ)</title>
    <style>
        :root {
            --felt-color: #35654d;
            --card-width: 50px;
            --card-height: 70px;
            --highlight-color: #ffd700;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 20px;
        }
        
        /* ç‰Œæ¡ŒåŒºåŸŸ */
        #game-table {
            position: relative;
            width: 800px;
            height: 500px;
            background-color: var(--felt-color);
            border: 15px solid #5d4037;
            border-radius: 250px;
            margin-top: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        #community-cards {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 10px;
        }

        #pot-display {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 15px;
            border: 1px solid #aaa;
        }

        /* ç©å®¶ */
        .player {
            position: absolute;
            width: 100px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .player-info {
            background: rgba(0,0,0,0.6);
            padding: 5px;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
            width: 100%;
            position: relative;
        }

        .player-cards {
            display: flex;
            margin-top: 5px;
            gap: 2px;
        }

        /* å¸ƒå±€ */
        #p0 { bottom: 10px; left: 50%; transform: translateX(-50%); }
        #p1 { bottom: 100px; left: 20px; }
        #p2 { top: 150px; left: 20px; }
        #p3 { top: 20px; left: 250px; }
        #p4 { top: 20px; right: 250px; }
        #p5 { top: 150px; right: 20px; }
        #p6 { bottom: 100px; right: 20px; }

        /* å¡ç‰Œ */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            border-radius: 4px;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            position: relative;
        }
        .card.red { color: #d00; }
        .card.back {
            background: repeating-linear-gradient(45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px);
            border: 2px solid white;
        }
        
        /* çŠ¶æ€æ ‡è®° */
        .dealer-btn {
            background: white; color: black; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: -10px; right: -10px; z-index: 10;
            display: none;
        }

        .active-turn { box-shadow: 0 0 15px 5px yellow; border-radius: 10px; }
        .folded { opacity: 0.5; filter: grayscale(100%); }
        .winner-highlight .player-info { border: 2px solid var(--highlight-color); background: rgba(255, 215, 0, 0.3); }

        /* æ§åˆ¶åŒº */
        #controls { margin-top: 15px; display: flex; gap: 15px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-fold { background: #d32f2f; color: white; }
        .btn-check { background: #1976d2; color: white; }
        .btn-raise { background: #388e3c; color: white; }
        .btn-next { background: #f57c00; color: white; display: none; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }

        #log-area {
            width: 800px; height: 100px; background: #111; margin-top: 10px;
            overflow-y: auto; padding: 10px; font-family: monospace; font-size: 14px;
            border: 1px solid #444; color: #ccc;
        }

        /* ç‰Œå‹å±•ç¤ºæ¡ */
        #hand-ranks-bar {
            width: 800px;
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            background: #222;
            padding: 5px 0;
            border-top: 2px solid #444;
        }
        .rank-item {
            font-size: 12px;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
            flex: 1;
            transition: all 0.3s;
        }
        .rank-active {
            color: #000;
            background-color: var(--highlight-color);
            font-weight: bold;
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--highlight-color);
        }
    </style>
</head>
<body>

    <div id="game-table">
        <div id="pot-display">Pot: 0</div>
        <div id="community-cards"></div>
        
        <div id="p0" class="player">
            <div class="player-info">
                <div>ä½  (P0)</div>
                <div>$<span class="chips">100</span></div>
                <div class="status"></div>
                <div class="dealer-btn">D</div>
            </div>
            <div class="player-cards"></div>
        </div>
        <div id="p1" class="player"><div class="player-info"><div>ç”µè„‘ 1</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p2" class="player"><div class="player-info"><div>ç”µè„‘ 2</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p3" class="player"><div class="player-info"><div>ç”µè„‘ 3</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p4" class="player"><div class="player-info"><div>ç”µè„‘ 4</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p5" class="player"><div class="player-info"><div>ç”µè„‘ 5</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p6" class="player"><div class="player-info"><div>ç”µè„‘ 6</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
    </div>

    <div id="controls">
        <button id="btn-fold" class="btn-fold" onclick="game.humanAction('fold')">å¼ƒç‰Œ</button>
        <button id="btn-call" class="btn-check" onclick="game.humanAction('call')">è·Ÿæ³¨/è¿‡ç‰Œ</button>
        <button id="btn-raise" class="btn-raise" onclick="game.humanAction('raise')">åŠ æ³¨ (10)</button>
        <button id="btn-next" class="btn-next" onclick="game.startNextRound()">ä¸‹ä¸€å±€</button>
    </div>

    <div id="log-area"></div>

    <div id="hand-ranks-bar">
        <div id="rank-0" class="rank-item">é«˜ç‰Œ<br>High Card</div>
        <div id="rank-1" class="rank-item">ä¸€å¯¹<br>Pair</div>
        <div id="rank-2" class="rank-item">ä¸¤å¯¹<br>Two Pair</div>
        <div id="rank-3" class="rank-item">ä¸‰æ¡<br>Trips</div>
        <div id="rank-4" class="rank-item">é¡ºå­<br>Straight</div>
        <div id="rank-5" class="rank-item">åŒèŠ±<br>Flush</div>
        <div id="rank-6" class="rank-item">è‘«èŠ¦<br>Full House</div>
        <div id="rank-7" class="rank-item">å››æ¡<br>Quads</div>
        <div id="rank-8" class="rank-item">åŒèŠ±é¡º<br>Str. Flush</div>
    </div>

<script>
/**
 * å¾·å·æ‰‘å…‹æ ¸å¿ƒé€»è¾‘ (ä¼˜åŒ–ç‰ˆ)
 */

const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
const RANK_VALUE = {'2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, 'T':10, 'J':11, 'Q':12, 'K':13, 'A':14};

class Card {
    constructor(rank, suit) {
        this.rank = rank;
        this.suit = suit;
        this.value = RANK_VALUE[rank];
    }
    get color() { return (this.suit === 'â™¥' || this.suit === 'â™¦') ? 'red' : 'black'; }
}

class Deck {
    constructor() { this.cards = []; this.reset(); }
    reset() {
        this.cards = [];
        for (let s of SUITS) for (let r of RANKS) this.cards.push(new Card(r, s));
        this.shuffle();
    }
    shuffle() {
        for (let i = this.cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
        }
    }
    deal() { return this.cards.pop(); }
}

// ç‰Œå‹å¸¸é‡
const HandRank = {
    HIGH_CARD: 0, PAIR: 1, TWO_PAIR: 2, TRIPS: 3, STRAIGHT: 4, 
    FLUSH: 5, FULL_HOUSE: 6, QUADS: 7, STRAIGHT_FLUSH: 8
};

function evaluateHand(cards) {
    cards.sort((a,b) => b.value - a.value);
    
    let suitCounts = {}, rankCounts = {};
    cards.forEach(c => {
        suitCounts[c.suit] = (suitCounts[c.suit] || 0) + 1;
        rankCounts[c.value] = (rankCounts[c.value] || 0) + 1;
    });

    let flushSuit = Object.keys(suitCounts).find(s => suitCounts[s] >= 5);
    let flushCards = flushSuit ? cards.filter(c => c.suit === flushSuit) : [];

    const getStraightHigh = (cardList) => {
        let u = [...new Set(cardList.map(c => c.value))].sort((a,b)=>b-a);
        if (u.includes(14)) u.push(1); // Aå¯å½“1
        for(let i=0; i<=u.length-5; i++) {
            if(u[i] - u[i+4] === 4) return u[i];
        }
        return null;
    };

    let straightHigh = getStraightHigh(cards);
    let straightFlushHigh = flushSuit ? getStraightHigh(flushCards) : null;

    if (straightFlushHigh) return [HandRank.STRAIGHT_FLUSH, straightFlushHigh];
    
    let quads = Object.keys(rankCounts).find(r => rankCounts[r] === 4);
    if (quads) return [HandRank.QUADS, parseInt(quads)];

    let trips = Object.keys(rankCounts).filter(r => rankCounts[r] === 3).sort((a,b)=>b-a);
    let pairs = Object.keys(rankCounts).filter(r => rankCounts[r] === 2).sort((a,b)=>b-a);
    
    if (trips.length > 0 && (trips.length > 1 || pairs.length > 0)) {
        let t = parseInt(trips[0]);
        let p = (trips.length > 1) ? parseInt(trips[1]) : parseInt(pairs[0]);
        return [HandRank.FULL_HOUSE, t * 100 + p];
    }

    if (flushSuit) return [HandRank.FLUSH, flushCards[0].value];
    if (straightHigh) return [HandRank.STRAIGHT, straightHigh];
    if (trips.length > 0) return [HandRank.TRIPS, parseInt(trips[0])];
    
    if (pairs.length >= 2) return [HandRank.TWO_PAIR, parseInt(pairs[0])*100 + parseInt(pairs[1])];
    if (pairs.length === 1) return [HandRank.PAIR, parseInt(pairs[0])];

    return [HandRank.HIGH_CARD, cards[0].value];
}

class PokerGame {
    constructor() {
        this.players = [];
        for(let i=0; i<7; i++) {
            this.players.push({
                id: i, isHuman: i === 0, chips: 100, hand: [], 
                status: 'active', currentBet: 0, isEliminated: false
            });
        }
        this.deck = new Deck();
        this.communityCards = [];
        this.pot = 0;
        this.dealerIdx = Math.floor(Math.random() * 7);
        this.highestBet = 0;
        this.stage = 'preflop';
        this.logElem = document.getElementById('log-area');
        
        // --- æ ¸å¿ƒä¼˜åŒ–å˜é‡ ---
        this.actorsLeft = 0; // å½“å‰è½®è¿˜éœ€è¦å¤šå°‘äººè¡¨æ€
        this.raisesInRound = 0; // é˜²æ­¢æ— é™åŠ æ³¨
        
        this.disableControls(true);
        this.startNextRound();
    }

    log(msg) {
        let div = document.createElement('div');
        div.textContent = msg;
        this.logElem.prepend(div);
    }

    startNextRound() {
        let activePlayers = this.players.filter(p => !p.isEliminated);
        if (activePlayers.length <= 1) {
            alert(`æ¸¸æˆç»“æŸ! è·èƒœè€…: P${activePlayers[0].id}`);
            return;
        }

        // æ¸…ç†UI
        document.querySelectorAll('.rank-item').forEach(el => el.classList.remove('rank-active'));
        document.querySelectorAll('.player').forEach(el => el.classList.remove('winner-highlight'));
        document.getElementById('btn-next').style.display = 'none';
        
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        this.deck.reset();
        this.communityCards = [];
        this.pot = 0;
        this.stage = 'preflop';
        this.players.forEach(p => {
            if(!p.isEliminated) {
                p.hand = [this.deck.deal(), this.deck.deal()];
                p.status = 'active';
                p.currentBet = 0;
            } else {
                p.status = 'eliminated';
                p.hand = [];
            }
        });

        // ç§»åŠ¨ Dealer
        do { this.dealerIdx = (this.dealerIdx + 1) % 7; } 
        while (this.players[this.dealerIdx].isEliminated);

        // ç›²æ³¨é€»è¾‘
        let sbIdx = this.getNextActive(this.dealerIdx);
        let bbIdx = this.getNextActive(sbIdx);
        
        this.bet(sbIdx, 5);
        this.bet(bbIdx, 10);
        this.highestBet = 10;
        
        // å…³é”®é€»è¾‘ï¼šè®¡ç®—éœ€è¦è¡ŒåŠ¨çš„äººæ•°
        // æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰äººéƒ½è¦è¡ŒåŠ¨ï¼Œé™¤äº†ç›²æ³¨å·²ä¸‹æ³¨ï¼ˆä½†å¤§ç›²å…¶å®è¿˜æœ‰æœºä¼šCheck/Raiseï¼‰
        // ç®€å•å¤„ç†ï¼šå°†å½“å‰è¡ŒåŠ¨ä½è®¾ä¸ºæªå£ä½ï¼ˆBBä¸‹ä¸€ä½ï¼‰ï¼Œæ‰€æœ‰æ´»è·ƒç©å®¶éƒ½éœ€è¦è¡¨æ€
        // è¿™é‡Œçš„ actorsLeft åœ¨ prepareBettingRound é‡Œè®¾ç½®
        
        this.log(`--- æ–°å›åˆ (D: P${this.dealerIdx}) ---`);
        this.updateUI();
        
        // å¼€å§‹ Preflop ä¸‹æ³¨è½®
        this.prepareBettingRound(this.getNextActive(bbIdx)); 
    }

    // å‡†å¤‡ä¸‹æ³¨è½®ï¼šé‡ç½®åŠ æ³¨è®¡æ•°ï¼Œè®¾ç½®è¡ŒåŠ¨äººæ•°
    prepareBettingRound(startIdx) {
        this.raisesInRound = 0;
        let activeCount = this.players.filter(p => p.status !== 'eliminated' && p.status !== 'folded').length;
        
        // å¦‚æœåªå‰©ä¸€äººï¼Œç›´æ¥ç»“æŸ
        if(activeCount < 2) {
            this.showdown();
            return;
        }

        // æ ¸å¿ƒä¿®æ­£ï¼šactorsLeft
        // è§„åˆ™ï¼šä¸€è½®å¼€å§‹æ—¶ï¼Œæ‰€æœ‰äººï¼ˆActive & Not Allinï¼‰éƒ½éœ€è¦è¡¨æ€ã€‚
        // å¦‚æœæ˜¯ Preflopï¼Œç›²æ³¨å·²ç»ä¸‹æ³¨ï¼Œä½†æªå£ä½å¼€å§‹ç®—ï¼Œç›´åˆ°å›åˆ°å¤§ç›²ã€‚
        // ç®€å•æ¨¡å‹ï¼šåªè¦ currentBet != highestBet æˆ–è€… è¿˜æ²¡è¡ŒåŠ¨è¿‡ï¼Œå°±éœ€è¦è¡ŒåŠ¨ã€‚
        // æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•è®¡æ•°å™¨ï¼šç­‰äºæ´»è·ƒäººæ•°ã€‚æ¯å½“æœ‰äººCall/Checkï¼Œå‡1ã€‚
        // å¦‚æœæœ‰äººRaiseï¼Œé‡ç½®ä¸º (æ´»è·ƒäººæ•° - 1)ã€‚
        
        this.actorsLeft = activeCount;
        this.currentTurnIdx = startIdx;
        
        // Preflop ç‰¹æ®Šå¤„ç†ï¼šç›²æ³¨å·²ç»ç®—ä½œä¸‹æ³¨ï¼Œä½†é€»è¾‘ä¸Šä»–ä»¬è¿˜æ²¡å¯¹ 10 è¿™ä¸ªBetè¡¨æ€
        // ä¸ºäº†é€šç”¨æ€§ï¼ŒPreflop æ—¶ actorsLeft ä¹Ÿæ˜¯å…¨å‘˜ï¼Œç›´åˆ°å¤§å®¶å¹³æ³¨
        
        this.processTurn();
    }

    getNextActive(idx) {
        let next = (idx + 1) % 7;
        while(this.players[next].isEliminated || this.players[next].status === 'folded') {
            next = (next + 1) % 7;
        }
        return next;
    }

    bet(playerIdx, amount) {
        let p = this.players[playerIdx];
        if (amount > p.chips) amount = p.chips;
        p.chips -= amount;
        p.currentBet += amount;
        this.pot += amount;
        if (p.currentBet > this.highestBet) this.highestBet = p.currentBet;
        if (p.chips === 0 && p.status !== 'folded') p.status = 'allin';
    }

    async processTurn() {
        // 1. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰äººéƒ½ All-in æˆ–è€…åªå‰©ä¸€äºº
        let active = this.players.filter(p => p.status !== 'eliminated' && p.status !== 'folded');
        let notAllIn = active.filter(p => p.status !== 'allin');
        
        if (active.length === 1 || (notAllIn.length === 0 && this.isBetsSettled())) {
            this.runRemainingStages();
            return;
        }

        // 2. æ£€æŸ¥æœ¬è½®ä¸‹æ³¨æ˜¯å¦ç»“æŸ
        // ç»“æŸæ¡ä»¶ï¼šactorsLeft <= 0 å¹¶ä¸” æ³¨ç å·²å¹³ (isBetsSettled)
        if (this.actorsLeft <= 0 && this.isBetsSettled()) {
            this.nextStage();
            return;
        }

        // 3. è½®åˆ°æŸäººè¡ŒåŠ¨
        let p = this.players[this.currentTurnIdx];
        
        // è·³è¿‡ All-in ç©å®¶
        if (p.status === 'allin') {
            this.currentTurnIdx = this.getNextActive(this.currentTurnIdx);
            // actorsLeft ä¸å‡ï¼Œå› ä¸ºä»–ä¸éœ€è¦è¡¨æ€
            this.processTurn(); 
            return;
        }

        // é«˜äº®å½“å‰ç©å®¶
        document.querySelectorAll('.player').forEach(el => el.classList.remove('active-turn'));
        document.getElementById(`p${p.id}`).classList.add('active-turn');

        if (p.isHuman) {
            this.log(">>> è½®åˆ°ä½ äº†");
            this.updateControls();
        } else {
            this.disableControls(true);
            setTimeout(() => this.aiAction(p), 600); // AI æ€è€ƒæ—¶é—´
        }
    }

    // è¾…åŠ©ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰äººæ³¨ç é½å¹³
    isBetsSettled() {
        let active = this.players.filter(p => p.status !== 'eliminated' && p.status !== 'folded' && p.status !== 'allin');
        if (active.length === 0) return true;
        let target = this.highestBet;
        return active.every(p => p.currentBet === target);
    }

    nextStage() {
        this.players.forEach(p => p.currentBet = 0);
        this.highestBet = 0;
        
        if (this.stage === 'preflop') {
            this.stage = 'flop';
            this.communityCards.push(this.deck.deal(), this.deck.deal(), this.deck.deal());
            this.log(`--- ç¿»ç‰Œ: ${this.communityCards.join(' ')} ---`);
        } else if (this.stage === 'flop') {
            this.stage = 'turn';
            this.communityCards.push(this.deck.deal());
            this.log(`--- è½¬ç‰Œ: ${this.communityCards[3]} ---`);
        } else if (this.stage === 'turn') {
            this.stage = 'river';
            this.communityCards.push(this.deck.deal());
            this.log(`--- æ²³ç‰Œ: ${this.communityCards[4]} ---`);
        } else if (this.stage === 'river') {
            this.showdown();
            return;
        }

        this.updateUI();
        // ä¸‹ä¸€è½®ä» Dealer åç¬¬ä¸€ä¸ªäººå¼€å§‹
        let startIdx = this.getNextActive(this.dealerIdx);
        this.prepareBettingRound(startIdx);
    }

    runRemainingStages() {
        // å¦‚æœå¤§å®¶éƒ½Allinäº†ï¼Œç›´æ¥å¿«é€Ÿå‘å®Œç‰Œè¿›æ‘Šç‰Œ
        while(this.stage !== 'showdown') {
             if (this.stage === 'river') { this.showdown(); return; }
             this.nextStage();
        }
    }

    showdown() {
        this.stage = 'showdown';
        document.querySelectorAll('.player').forEach(el => el.classList.remove('active-turn'));
        this.updateUI();

        let active = this.players.filter(p => p.status !== 'folded' && p.status !== 'eliminated');
        let bestPlayer = null;
        let bestScore = -1;
        let bestRankIdx = -1;

        this.log("--- æ‘Šç‰Œæ—¶åˆ» ---");

        active.forEach(p => {
            let fullHand = [...p.hand, ...this.communityCards];
            let result = evaluateHand(fullHand); // [rankIdx, score]
            let rankIdx = result[0];
            let score = rankIdx * 1000000 + result[1]; // ç¡®ä¿ Rank æƒé‡æœ€å¤§
            
            // å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰æœªå¼ƒç‰Œç©å®¶çš„ç‰Œ
            this.renderCards(p.id, p.hand, true);
            
            this.log(`P${p.id}: ${this.getRankName(rankIdx)}`);

            if (score > bestScore) {
                bestScore = score;
                bestPlayer = p;
                bestRankIdx = rankIdx;
            }
        });

        if (bestPlayer) {
            this.log(`ğŸ‰ P${bestPlayer.id} è·èƒœ! èµ¢å¾— $${this.pot}`);
            bestPlayer.chips += this.pot;
            
            // è§†è§‰æ•ˆæœï¼šé«˜äº®èµ¢å®¶ å’Œ å¯¹åº”çš„ç‰Œå‹
            document.getElementById(`p${bestPlayer.id}`).classList.add('winner-highlight');
            let rankEl = document.getElementById(`rank-${bestRankIdx}`);
            if(rankEl) rankEl.classList.add('rank-active');
        }

        // æ¸…ç®—
        this.players.forEach(p => {
            if (p.chips <= 0) {
                p.chips = 0; p.isEliminated = true; p.status = 'eliminated';
            }
        });

        this.pot = 0;
        this.updateUI();
        document.getElementById('btn-next').style.display = 'block';
        this.disableControls(true);
    }
    
    getRankName(idx) {
        const names = ["é«˜ç‰Œ", "ä¸€å¯¹", "ä¸¤å¯¹", "ä¸‰æ¡", "é¡ºå­", "åŒèŠ±", "è‘«èŠ¦", "å››æ¡", "åŒèŠ±é¡º"];
        return names[idx];
    }

    // --- ç©å®¶è¡ŒåŠ¨å¤„ç† ---

    handleAction(player, action, amount=0) {
        let callAmt = this.highestBet - player.currentBet;
        
        if (action === 'fold') {
            player.status = 'folded';
            this.log(`P${player.id} å¼ƒç‰Œ`);
            // ä¸å‡ actorsLeftï¼Œå› ä¸ºå¼ƒç‰Œä¹Ÿç®—ä¸€ç§è¡¨æ€ï¼Œä½†ä¸‹ä¸€è½®å¾ªç¯ä¸å¸¦ä»–äº†
        } else if (action === 'call') {
            this.bet(player.id, callAmt);
            let msg = (callAmt === 0) ? "è¿‡ç‰Œ" : "è·Ÿæ³¨";
            this.log(`P${player.id} ${msg}`);
        } else if (action === 'raise') {
            // åŠ æ³¨é€»è¾‘ï¼šé‡ç½® actorsLeft
            let raiseAmt = callAmt + amount;
            this.bet(player.id, raiseAmt);
            this.log(`P${player.id} åŠ æ³¨ ${amount}`);
            this.raisesInRound++;
            
            // é‡è¦ï¼šæœ‰äººåŠ æ³¨ï¼Œé™¤äº†åŠ æ³¨è€…ï¼Œå…¶ä»–æ‰€æœ‰æ´»è·ƒéAllinç©å®¶éƒ½éœ€è¦å†æ¬¡è¡¨æ€
            let activeNotAllIn = this.players.filter(p => 
                p.status !== 'folded' && p.status !== 'eliminated' && p.status !== 'allin'
            ).length;
            this.actorsLeft = activeNotAllIn; // é‡ç½®è®¡æ•°å™¨
            // è¿™é‡Œ actorsLeft è®¾ä¸ºæ€»äººæ•°ï¼Œå› ä¸ºå½“å‰å‡½æ•°æœ€åä¼šå‡1ï¼Œæ‰€ä»¥åˆšå¥½æ¶µç›–é™¤è‡ªå·±å¤–çš„æ‰€æœ‰äºº
        }

        // è¡ŒåŠ¨å®Œï¼Œè®¡æ•°å™¨å‡1
        this.actorsLeft--;
        this.updateUI();
        
        // ç§»äº¤ä¸‹ä¸€ä½
        this.currentTurnIdx = this.getNextActive(this.currentTurnIdx);
        this.processTurn();
    }

    humanAction(type) {
        let p = this.players[0];
        if (type === 'raise') this.handleAction(p, 'raise', 10);
        else this.handleAction(p, type);
    }

    aiAction(player) {
        let callAmt = this.highestBet - player.currentBet;
        let fullHand = [...player.hand, ...this.communityCards];
        let action = 'fold';

        // ç®€å•çš„ AI ç­–ç•¥
        let strength = 0; 
        if (fullHand.length < 5) {
            // Preflop: çœ‹æ˜¯å¦æœ‰å¯¹å­æˆ–å¤§ç‰Œ
            let v1 = player.hand[0].value, v2 = player.hand[1].value;
            if (v1 === v2) strength = 2; // å¯¹å­
            else if (v1 > 10 && v2 > 10) strength = 1.5; // ä¸¤å¼ å¤§ç‰Œ
            else if (v1 > 12 || v2 > 12) strength = 1; // å•å¼ å¤§ç‰Œ
        } else {
            // Postflop
            let res = evaluateHand(fullHand);
            strength = res[0] + (res[1] / 100); // ç‰Œå‹æƒé‡
        }

        // å†³ç­–è½¬æ¢
        // å¦‚æœè¿™è½®åŠ æ³¨å¤ªå¤šï¼Œç”µè„‘å€¾å‘äºä¸åŠ æ³¨ï¼Œé˜²æ­¢æ­»å¾ªç¯
        let canRaise = (this.raisesInRound < 4); 

        if (strength >= 2) { // å¼ºç‰Œ
            if (canRaise && Math.random() > 0.4) action = 'raise';
            else action = 'call';
        } else if (strength >= 1) { // ä¸­ç­‰ç‰Œ
            if (callAmt < 20) action = 'call';
            else action = Math.random() > 0.6 ? 'call' : 'fold';
        } else { // å¼±ç‰Œ
            if (callAmt === 0) action = 'call'; // å…è´¹çœ‹ç‰Œ
            else action = Math.random() > 0.85 ? 'raise' : 'fold'; // å¶å°”è¯ˆå”¬
        }
        
        if (action === 'raise') this.handleAction(player, 'raise', 10);
        else this.handleAction(player, action);
    }

    // --- UI æ›´æ–° ---
    updateUI() {
        document.getElementById('pot-display').textContent = `Pot: ${this.pot}`;
        document.getElementById('community-cards').innerHTML = this.communityCards.map(c => this.createCardHtml(c)).join('');

        this.players.forEach(p => {
            let el = document.getElementById(`p${p.id}`);
            el.querySelector('.chips').textContent = p.chips;
            
            let statusText = '';
            if (p.status === 'folded') statusText = 'Fold';
            else if (p.status === 'eliminated') statusText = 'Out';
            else if (p.status === 'allin') statusText = 'All-in';
            else if (p.currentBet > 0) statusText = `$${p.currentBet}`;
            
            el.querySelector('.status').textContent = statusText;
            el.querySelector('.dealer-btn').style.display = (this.dealerIdx === p.id) ? 'flex' : 'none';

            if (p.hand.length > 0) {
                // ä»…æ˜¾ç¤ºï¼šç©å®¶è‡ªå·± OR æ‘Šç‰Œé˜¶æ®µ OR å·²ç»Foldä½†ä¸ºäº†è§†è§‰æ•ˆæœ(å¯é€‰)
                let showFace = (p.isHuman || this.stage === 'showdown');
                this.renderCards(p.id, p.hand, showFace);
            } else {
                el.querySelector('.player-cards').innerHTML = '';
            }
            
            if (p.status === 'folded') el.querySelector('.player-cards').classList.add('folded');
            else el.querySelector('.player-cards').classList.remove('folded');

            if (p.isEliminated) el.style.opacity = 0.3;
        });
    }

    renderCards(pid, cards, showFace) {
        let html = '';
        if (showFace) {
            html = cards.map(c => this.createCardHtml(c)).join('');
        } else {
            html = `<div class="card back"></div><div class="card back"></div>`;
        }
        document.getElementById(`p${pid}`).querySelector('.player-cards').innerHTML = html;
    }

    createCardHtml(card) {
        return `<div class="card ${card.color}">${card.suit}<br>${card.rank}</div>`;
    }

    updateControls() {
        let p = this.players[0];
        let callAmt = this.highestBet - p.currentBet;
        
        document.getElementById('btn-fold').disabled = false;
        document.getElementById('btn-call').disabled = false;
        // å¦‚æœåŠ æ³¨è¶…è¿‡é™åˆ¶ï¼Œæˆ–æ˜¯AllinçŠ¶æ€ï¼Œä¸èƒ½åŠ æ³¨
        document.getElementById('btn-raise').disabled = (p.chips <= callAmt) || (this.raisesInRound >= 4);
        
        document.getElementById('btn-call').textContent = (callAmt === 0) ? "è¿‡ç‰Œ" : `è·Ÿæ³¨ (${callAmt})`;
    }

    disableControls(disabled) {
        document.getElementById('btn-fold').disabled = disabled;
        document.getElementById('btn-call').disabled = disabled;
        document.getElementById('btn-raise').disabled = disabled;
    }
}

const game = new PokerGame();
</script>
</body>
</html>
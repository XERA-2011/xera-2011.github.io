<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âæ∑Â∑ûÊâëÂÖã (ÊúÄÁªàÂÆåÁæéÁâà)</title>
    <style>
        :root {
            --felt-color: #35654d;
            --card-width: 50px;
            --card-height: 70px;
            --highlight-color: #ffd700;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 20px;
            user-select: none;
        }
        
        #game-table {
            position: relative;
            width: 800px;
            height: 500px;
            background-color: var(--felt-color);
            border: 15px solid #5d4037;
            border-radius: 250px;
            margin-top: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        #community-cards {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 10px;
        }

        #pot-display {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 15px;
            border: 1px solid #aaa;
            z-index: 10;
        }

        .player {
            position: absolute;
            width: 100px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .player-info {
            background: rgba(0,0,0,0.6);
            padding: 5px;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
            width: 100%;
            position: relative;
            z-index: 20;
        }

        .player-cards {
            display: flex;
            margin-top: 5px;
            gap: 2px;
            z-index: 20;
        }

        /* Â∏ÉÂ±ÄÂùêÊ†á */
        #p0 { bottom: 10px; left: 50%; transform: translateX(-50%); }
        #p1 { bottom: 100px; left: 20px; }
        #p2 { top: 150px; left: 20px; }
        #p3 { top: 20px; left: 250px; }
        #p4 { top: 20px; right: 250px; }
        #p5 { top: 150px; right: 20px; }
        #p6 { bottom: 100px; right: 20px; }

        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            border-radius: 4px;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card.red { color: #d00; }
        .card.back {
            background: repeating-linear-gradient(45deg, #606dbc, #606dbc 10px, #465298 10px, #465298 20px);
            border: 2px solid white;
        }
        
        /* === Ê†∏ÂøÉÊñ∞Â¢ûÔºöËé∑ËÉúÁâåÈ´ò‰∫ÆÊ†∑Âºè === */
        .card.winning-card {
            border: 3px solid #ffd700; /* ÈáëËâ≤ËæπÊ°Ü */
            transform: translateY(-15px) scale(1.15); /* ‰∏äÊµÆÊîæÂ§ß */
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); /* ÂèëÂÖâ */
            z-index: 100;
        }

        .dealer-btn {
            background: white; color: black; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: -10px; right: -10px; z-index: 30;
            display: none;
            box-shadow: 0 0 5px black;
        }

        .active-turn { box-shadow: 0 0 15px 5px yellow; border-radius: 10px; }
        .folded { opacity: 0.5; filter: grayscale(100%); }
        .winner-highlight .player-info { 
            border: 2px solid var(--highlight-color); 
            background: rgba(255, 215, 0, 0.3); 
            color: #fff;
            text-shadow: 0 0 5px gold;
        }

        #controls { margin-top: 15px; display: flex; gap: 15px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-fold { background: #d32f2f; color: white; }
        .btn-check { background: #1976d2; color: white; }
        .btn-raise { background: #388e3c; color: white; }
        .btn-next { background: #f57c00; color: white; display: none; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }

        #log-area {
            width: 800px; height: 100px; background: #111; margin-top: 10px;
            overflow-y: auto; padding: 10px; font-family: monospace; font-size: 14px;
            border: 1px solid #444; color: #ccc;
        }

        #hand-ranks-bar {
            width: 800px; display: flex; justify-content: space-between;
            margin-top: 10px; background: #222; padding: 5px 0; border-top: 2px solid #444;
        }
        .rank-item {
            font-size: 12px; color: #666; padding: 5px; border-radius: 4px;
            text-align: center; flex: 1; transition: all 0.3s;
        }
        .rank-active {
            color: #000; background-color: var(--highlight-color);
            font-weight: bold; transform: scale(1.1);
            box-shadow: 0 0 10px var(--highlight-color);
        }
    </style>
</head>
<body>

    <div id="game-table">
        <div id="pot-display">Pot: 0</div>
        <div id="community-cards"></div>
        
        <div id="p0" class="player"><div class="player-info"><div>‰Ω† (P0)</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p1" class="player"><div class="player-info"><div>ÁîµËÑë 1</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p2" class="player"><div class="player-info"><div>ÁîµËÑë 2</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p3" class="player"><div class="player-info"><div>ÁîµËÑë 3</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p4" class="player"><div class="player-info"><div>ÁîµËÑë 4</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p5" class="player"><div class="player-info"><div>ÁîµËÑë 5</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
        <div id="p6" class="player"><div class="player-info"><div>ÁîµËÑë 6</div><div>$<span class="chips">100</span></div><div class="status"></div><div class="dealer-btn">D</div></div><div class="player-cards"></div></div>
    </div>

    <div id="controls">
        <button id="btn-fold" class="btn-fold" onclick="game.humanAction('fold')">ÂºÉÁâå</button>
        <button id="btn-call" class="btn-check" onclick="game.humanAction('call')">Ë∑üÊ≥®/ËøáÁâå</button>
        <button id="btn-raise" class="btn-raise" onclick="game.humanAction('raise')">Âä†Ê≥® (10)</button>
        <button id="btn-next" class="btn-next" onclick="game.startNextRound()">‰∏ã‰∏ÄÂ±Ä</button>
    </div>

    <div id="log-area"></div>

    <div id="hand-ranks-bar">
        <div id="rank-0" class="rank-item">È´òÁâå</div>
        <div id="rank-1" class="rank-item">‰∏ÄÂØπ</div>
        <div id="rank-2" class="rank-item">‰∏§ÂØπ</div>
        <div id="rank-3" class="rank-item">‰∏âÊù°</div>
        <div id="rank-4" class="rank-item">È°∫Â≠ê</div>
        <div id="rank-5" class="rank-item">ÂêåËä±</div>
        <div id="rank-6" class="rank-item">Ëë´Ëä¶</div>
        <div id="rank-7" class="rank-item">ÂõõÊù°</div>
        <div id="rank-8" class="rank-item">ÂêåËä±È°∫</div>
    </div>

<script>
const SUITS = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'];
const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
const RANK_VALUE = {'2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, 'T':10, 'J':11, 'Q':12, 'K':13, 'A':14};

class Card {
    constructor(rank, suit) {
        this.rank = rank;
        this.suit = suit;
        this.value = RANK_VALUE[rank];
    }
    get color() { return (this.suit === '‚ô•' || this.suit === '‚ô¶') ? 'red' : 'black'; }
    equals(other) { return this.rank === other.rank && this.suit === other.suit; }
}

class Deck {
    constructor() { this.cards = []; this.reset(); }
    reset() {
        this.cards = [];
        for (let s of SUITS) for (let r of RANKS) this.cards.push(new Card(r, s));
        this.shuffle();
    }
    shuffle() {
        for (let i = this.cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
        }
    }
    deal() { return this.cards.pop(); }
}

const HandRank = {
    HIGH_CARD: 0, PAIR: 1, TWO_PAIR: 2, TRIPS: 3, STRAIGHT: 4, 
    FLUSH: 5, FULL_HOUSE: 6, QUADS: 7, STRAIGHT_FLUSH: 8
};

/**
 * ÊîπËøõÁâàËØÑ‰º∞ÂáΩÊï∞
 * ËøîÂõûÂØπË±°: { rank: HandRank, score: number, bestFive: Card[] }
 */
function evaluateHand(cards) {
    // Â§çÂà∂‰∏Ä‰ªΩÂπ∂ÊåâÂ§ßÂ∞èÈôçÂ∫èÊéíÂ∫è
    let sorted = [...cards].sort((a,b) => b.value - a.value);
    
    let suitCounts = {}, rankCounts = {};
    sorted.forEach(c => {
        suitCounts[c.suit] = (suitCounts[c.suit] || 0) + 1;
        rankCounts[c.value] = (rankCounts[c.value] || 0) + 1;
    });

    // 1. ÂêåËä±Ê£ÄÊü• (Flush)
    let flushSuit = Object.keys(suitCounts).find(s => suitCounts[s] >= 5);
    let flushCards = flushSuit ? sorted.filter(c => c.suit === flushSuit) : [];

    // È°∫Â≠êÊ£ÄÊµãËæÖÂä©
    const getStraight = (cardList) => {
        let unique = [];
        cardList.forEach(c => { if(!unique.find(u => u.value === c.value)) unique.push(c); });
        
        // ÁâπÊÆäÂ§ÑÁêÜ A (14 -> 1)
        if (unique.some(c => c.value === 14)) {
            // Â§çÂà∂‰∏Ä‰∏™ A Êîπ‰∏∫ value 1 ÊîæÂà∞Êú´Â∞æ
            let aceLow = new Card('A', unique.find(c=>c.value===14).suit);
            aceLow.value = 1;
            unique.push(aceLow);
        }
        
        for(let i=0; i<=unique.length-5; i++) {
            if(unique[i].value - unique[i+4].value === 4) {
                // ÊâæÂà∞‰∫ÜËøûÁª≠5‰∏™
                return unique.slice(i, i+5);
            }
        }
        return null;
    };

    let straightCards = getStraight(sorted);
    let straightFlushCards = flushSuit ? getStraight(flushCards) : null;

    // --- Âà§ÂÆöÂºÄÂßã ---

    // 8. ÂêåËä±È°∫
    if (straightFlushCards) {
        return { 
            rank: HandRank.STRAIGHT_FLUSH, 
            score: straightFlushCards[0].value, 
            bestFive: straightFlushCards 
        };
    }

    // 7. ÂõõÊù°
    let quadsVal = Object.keys(rankCounts).find(r => rankCounts[r] === 4);
    if (quadsVal) {
        quadsVal = parseInt(quadsVal);
        let quads = sorted.filter(c => c.value === quadsVal);
        let kicker = sorted.find(c => c.value !== quadsVal);
        return { 
            rank: HandRank.QUADS, 
            score: quadsVal, 
            bestFive: [...quads, kicker] 
        };
    }

    // 6. Ëë´Ëä¶
    let tripsVals = Object.keys(rankCounts).filter(r => rankCounts[r] === 3).map(Number).sort((a,b)=>b-a);
    let pairVals = Object.keys(rankCounts).filter(r => rankCounts[r] === 2).map(Number).sort((a,b)=>b-a);
    
    if (tripsVals.length > 0) {
        let tVal = tripsVals[0];
        let pVal = -1;
        if (tripsVals.length > 1) pVal = tripsVals[1];
        else if (pairVals.length > 0) pVal = pairVals[0];

        if (pVal !== -1) {
            let tCards = sorted.filter(c => c.value === tVal);
            let pCards = sorted.filter(c => c.value === pVal).slice(0, 2);
            return { 
                rank: HandRank.FULL_HOUSE, 
                score: tVal * 100 + pVal, 
                bestFive: [...tCards, ...pCards] 
            };
        }
    }

    // 5. ÂêåËä±
    if (flushCards.length >= 5) {
        return { 
            rank: HandRank.FLUSH, 
            score: flushCards[0].value, 
            bestFive: flushCards.slice(0, 5) 
        };
    }

    // 4. È°∫Â≠ê
    if (straightCards) {
        return { 
            rank: HandRank.STRAIGHT, 
            score: straightCards[0].value, 
            bestFive: straightCards 
        };
    }

    // 3. ‰∏âÊù°
    if (tripsVals.length > 0) {
        let tVal = tripsVals[0];
        let trips = sorted.filter(c => c.value === tVal);
        let kickers = sorted.filter(c => c.value !== tVal).slice(0, 2);
        return { 
            rank: HandRank.TRIPS, 
            score: tVal, 
            bestFive: [...trips, ...kickers] 
        };
    }

    // 2. ‰∏§ÂØπ
    if (pairVals.length >= 2) {
        let p1 = pairVals[0], p2 = pairVals[1];
        let pair1 = sorted.filter(c => c.value === p1);
        let pair2 = sorted.filter(c => c.value === p2);
        let kicker = sorted.find(c => c.value !== p1 && c.value !== p2);
        return { 
            rank: HandRank.TWO_PAIR, 
            score: p1*100 + p2, 
            bestFive: [...pair1, ...pair2, kicker] 
        };
    }

    // 1. ‰∏ÄÂØπ
    if (pairVals.length === 1) {
        let p1 = pairVals[0];
        let pair = sorted.filter(c => c.value === p1);
        let kickers = sorted.filter(c => c.value !== p1).slice(0, 3);
        return { 
            rank: HandRank.PAIR, 
            score: p1, 
            bestFive: [...pair, ...kickers] 
        };
    }

    // 0. È´òÁâå
    return { 
        rank: HandRank.HIGH_CARD, 
        score: sorted[0].value, 
        bestFive: sorted.slice(0, 5) 
    };
}

class PokerGame {
    constructor() {
        this.players = [];
        for(let i=0; i<7; i++) {
            this.players.push({
                id: i, isHuman: i === 0, chips: 100, hand: [], 
                status: 'active', currentBet: 0, isEliminated: false
            });
        }
        this.deck = new Deck();
        this.communityCards = [];
        this.pot = 0;
        this.dealerIdx = Math.floor(Math.random() * 7);
        this.highestBet = 0;
        this.stage = 'preflop';
        this.logElem = document.getElementById('log-area');
        this.actorsLeft = 0; 
        this.raisesInRound = 0;
        
        this.disableControls(true);
        this.startNextRound();
    }

    log(msg) {
        let div = document.createElement('div');
        div.textContent = msg;
        this.logElem.prepend(div);
    }

    startNextRound() {
        let activePlayers = this.players.filter(p => !p.isEliminated);
        if (activePlayers.length <= 1) {
            alert(`Ê∏∏ÊàèÁªìÊùü! Ëé∑ËÉúËÄÖ: P${activePlayers[0].id}`);
            return;
        }

        // Ê∏ÖÁêÜUI
        document.querySelectorAll('.rank-item').forEach(el => el.classList.remove('rank-active'));
        document.querySelectorAll('.player').forEach(el => el.classList.remove('winner-highlight'));
        document.querySelectorAll('.card').forEach(el => el.classList.remove('winning-card')); // Ê∏ÖÈô§È´ò‰∫Æ
        document.getElementById('btn-next').style.display = 'none';
        
        this.deck.reset();
        this.communityCards = [];
        this.pot = 0;
        this.stage = 'preflop';
        this.players.forEach(p => {
            if(!p.isEliminated) {
                p.hand = [this.deck.deal(), this.deck.deal()];
                p.status = 'active';
                p.currentBet = 0;
            } else {
                p.status = 'eliminated';
                p.hand = [];
            }
        });

        do { this.dealerIdx = (this.dealerIdx + 1) % 7; } 
        while (this.players[this.dealerIdx].isEliminated);

        let sbIdx = this.getNextActive(this.dealerIdx);
        let bbIdx = this.getNextActive(sbIdx);
        
        this.bet(sbIdx, 5);
        this.bet(bbIdx, 10);
        this.highestBet = 10;
        
        this.log(`--- Êñ∞ÂõûÂêà (D: P${this.dealerIdx}) ---`);
        this.updateUI();
        this.prepareBettingRound(this.getNextActive(bbIdx)); 
    }

    prepareBettingRound(startIdx) {
        this.raisesInRound = 0;
        let activeCount = this.players.filter(p => p.status !== 'eliminated' && p.status !== 'folded').length;
        if(activeCount < 2) { this.showdown(); return; }
        this.actorsLeft = activeCount;
        this.currentTurnIdx = startIdx;
        this.processTurn();
    }

    getNextActive(idx) {
        let next = (idx + 1) % 7;
        while(this.players[next].isEliminated || this.players[next].status === 'folded') {
            next = (next + 1) % 7;
        }
        return next;
    }

    bet(playerIdx, amount) {
        let p = this.players[playerIdx];
        if (amount > p.chips) amount = p.chips;
        p.chips -= amount;
        p.currentBet += amount;
        this.pot += amount;
        if (p.currentBet > this.highestBet) this.highestBet = p.currentBet;
        if (p.chips === 0 && p.status !== 'folded') p.status = 'allin';
    }

    async processTurn() {
        let active = this.players.filter(p => p.status !== 'eliminated' && p.status !== 'folded');
        let notAllIn = active.filter(p => p.status !== 'allin');
        
        if (active.length === 1 || (notAllIn.length === 0 && this.isBetsSettled())) {
            this.runRemainingStages();
            return;
        }

        if (this.actorsLeft <= 0 && this.isBetsSettled()) {
            this.nextStage();
            return;
        }

        let p = this.players[this.currentTurnIdx];
        if (p.status === 'allin') {
            this.currentTurnIdx = this.getNextActive(this.currentTurnIdx);
            this.processTurn(); 
            return;
        }

        document.querySelectorAll('.player').forEach(el => el.classList.remove('active-turn'));
        document.getElementById(`p${p.id}`).classList.add('active-turn');

        if (p.isHuman) {
            this.log(">>> ËΩÆÂà∞‰Ω†‰∫Ü");
            this.updateControls();
        } else {
            this.disableControls(true);
            setTimeout(() => this.aiAction(p), 600);
        }
    }

    isBetsSettled() {
        let active = this.players.filter(p => p.status !== 'eliminated' && p.status !== 'folded' && p.status !== 'allin');
        if (active.length === 0) return true;
        let target = this.highestBet;
        return active.every(p => p.currentBet === target);
    }

    nextStage() {
        this.players.forEach(p => p.currentBet = 0);
        this.highestBet = 0;
        
        if (this.stage === 'preflop') {
            this.stage = 'flop';
            this.communityCards.push(this.deck.deal(), this.deck.deal(), this.deck.deal());
            this.log(`--- ÁøªÁâå ---`);
        } else if (this.stage === 'flop') {
            this.stage = 'turn';
            this.communityCards.push(this.deck.deal());
            this.log(`--- ËΩ¨Áâå ---`);
        } else if (this.stage === 'turn') {
            this.stage = 'river';
            this.communityCards.push(this.deck.deal());
            this.log(`--- Ê≤≥Áâå ---`);
        } else if (this.stage === 'river') {
            this.showdown();
            return;
        }

        this.updateUI();
        let startIdx = this.getNextActive(this.dealerIdx);
        this.prepareBettingRound(startIdx);
    }

    runRemainingStages() {
        while(this.stage !== 'showdown') {
             if (this.stage === 'river') { this.showdown(); return; }
             this.nextStage();
        }
    }

    showdown() {
        this.stage = 'showdown';
        document.querySelectorAll('.player').forEach(el => el.classList.remove('active-turn'));
        this.updateUI(); // ÂÖàÊòæÁ§∫ÊâÄÊúâ‰∫∫ÁöÑÁâå

        let active = this.players.filter(p => p.status !== 'folded' && p.status !== 'eliminated');
        let bestPlayer = null;
        let bestScore = -1;
        let bestRes = null;

        this.log("--- ÊëäÁâåÊó∂Âàª ---");

        active.forEach(p => {
            let fullHand = [...p.hand, ...this.communityCards];
            let res = evaluateHand(fullHand); // Ëé∑ÂèñÂÆåÊï¥ÁªìÊûúÂØπË±°
            
            // ÁÆÄÂçïÁöÑÂàÜÊï∞ËÆ°ÁÆó: Rank * 1M + tiebreaker
            let score = res.rank * 1000000 + res.score; 
            
            // Âº∫Âà∂ÊòæÁ§∫ÊâÄÊúâÊú™ÂºÉÁâåÁé©ÂÆ∂ÁöÑÁâå
            this.renderCards(p.id, p.hand, true);
            this.log(`P${p.id}: ${this.getRankName(res.rank)}`);

            if (score > bestScore) {
                bestScore = score;
                bestPlayer = p;
                bestRes = res;
            }
        });

        if (bestPlayer && bestRes) {
            this.log(`üéâ P${bestPlayer.id} Ëé∑ËÉú! Ëµ¢Âæó $${this.pot}`);
            bestPlayer.chips += this.pot;
            
            // 1. È´ò‰∫ÆÁé©ÂÆ∂Ê°Ü
            document.getElementById(`p${bestPlayer.id}`).classList.add('winner-highlight');
            
            // 2. È´ò‰∫ÆÁâåÂûãÊ†è
            let rankEl = document.getElementById(`rank-${bestRes.rank}`);
            if(rankEl) rankEl.classList.add('rank-active');

            // 3. È´ò‰∫ÆÂÖ∑‰ΩìÁöÑ 5 Âº†Áâå (Ê†∏ÂøÉ‰øÆÊîπ)
            this.highlightWinningCards(bestPlayer.id, bestRes.bestFive);
        }

        // Ê∏ÖÁÆó
        this.players.forEach(p => {
            if (p.chips <= 0) {
                p.chips = 0; p.isEliminated = true; p.status = 'eliminated';
            }
        });

        this.pot = 0;
        // ÈáçÊñ∞updateUI‰∏ÄÊ¨°‰ª•ÊòæÁ§∫Á≠πÁ†ÅÂèòÂåñÔºå‰ΩÜ‰øùÊåÅÈ´ò‰∫ÆÁä∂ÊÄÅ
        document.getElementById('pot-display').textContent = `Pot: 0`;
        this.players.forEach(p => document.querySelector(`#p${p.id} .chips`).textContent = p.chips);
        
        document.getElementById('btn-next').style.display = 'block';
        this.disableControls(true);
    }

    /**
     * È´ò‰∫ÆËé∑ËÉúÁöÑ5Âº†Áâå
     * @param {number} winnerId Ëé∑ËÉúËÄÖID
     * @param {Card[]} winningCards ÊûÑÊàêËé∑ËÉúÁâåÂûãÁöÑ5Âº†ÁâåÂØπË±°Êï∞ÁªÑ
     */
    highlightWinningCards(winnerId, winningCards) {
        // ËæÖÂä©ÂáΩÊï∞ÔºöÊ£ÄÊü•‰∏ÄÂº†ÁâåÊòØÂê¶Âú®Ëé∑ËÉúÊï∞ÁªÑÈáå
        const isWinner = (c) => winningCards.some(wc => wc.suit === c.suit && wc.rank === c.rank);

        // 1. ÈáçÊñ∞Ê∏≤ÊüìËµ¢ÂÆ∂ÁöÑÊâãÁâåÔºåÂ∏¶È´ò‰∫ÆÈÄªËæë
        let p = this.players[winnerId];
        let pCardsHtml = p.hand.map(c => this.createCardHtml(c, isWinner(c))).join('');
        document.querySelector(`#p${winnerId} .player-cards`).innerHTML = pCardsHtml;

        // 2. ÈáçÊñ∞Ê∏≤ÊüìÂÖ¨ÂÖ±ÁâåÔºåÂ∏¶È´ò‰∫ÆÈÄªËæë
        let commHtml = this.communityCards.map(c => this.createCardHtml(c, isWinner(c))).join('');
        document.getElementById('community-cards').innerHTML = commHtml;
    }
    
    getRankName(idx) {
        const names = ["È´òÁâå", "‰∏ÄÂØπ", "‰∏§ÂØπ", "‰∏âÊù°", "È°∫Â≠ê", "ÂêåËä±", "Ëë´Ëä¶", "ÂõõÊù°", "ÂêåËä±È°∫"];
        return names[idx];
    }

    handleAction(player, action, amount=0) {
        let callAmt = this.highestBet - player.currentBet;
        if (action === 'fold') {
            player.status = 'folded';
            this.log(`P${player.id} ÂºÉÁâå`);
        } else if (action === 'call') {
            this.bet(player.id, callAmt);
            let msg = (callAmt === 0) ? "ËøáÁâå" : "Ë∑üÊ≥®";
            this.log(`P${player.id} ${msg}`);
        } else if (action === 'raise') {
            let raiseAmt = callAmt + amount;
            this.bet(player.id, raiseAmt);
            this.log(`P${player.id} Âä†Ê≥® ${amount}`);
            this.raisesInRound++;
            let activeNotAllIn = this.players.filter(p => 
                p.status !== 'folded' && p.status !== 'eliminated' && p.status !== 'allin'
            ).length;
            this.actorsLeft = activeNotAllIn; 
        }
        this.actorsLeft--;
        this.updateUI();
        this.currentTurnIdx = this.getNextActive(this.currentTurnIdx);
        this.processTurn();
    }

    humanAction(type) {
        let p = this.players[0];
        if (type === 'raise') this.handleAction(p, 'raise', 10);
        else this.handleAction(p, type);
    }

    aiAction(player) {
        let callAmt = this.highestBet - player.currentBet;
        let fullHand = [...player.hand, ...this.communityCards];
        let action = 'fold';
        let strength = 0; 

        if (fullHand.length < 5) {
            let v1 = player.hand[0].value, v2 = player.hand[1].value;
            if (v1 === v2) strength = 2;
            else if (v1 > 10 && v2 > 10) strength = 1.5;
            else if (v1 > 12 || v2 > 12) strength = 1;
        } else {
            let res = evaluateHand(fullHand);
            strength = res.rank + (res.score / 1000000); 
        }

        let canRaise = (this.raisesInRound < 4); 
        if (strength >= 2) { 
            if (canRaise && Math.random() > 0.4) action = 'raise'; else action = 'call';
        } else if (strength >= 1) { 
            if (callAmt < 20) action = 'call'; else action = Math.random() > 0.6 ? 'call' : 'fold';
        } else { 
            if (callAmt === 0) action = 'call'; else action = Math.random() > 0.85 ? 'raise' : 'fold';
        }
        
        if (action === 'raise') this.handleAction(player, 'raise', 10);
        else this.handleAction(player, action);
    }

    updateUI() {
        document.getElementById('pot-display').textContent = `Pot: ${this.pot}`;
        // ÊôÆÈÄöÊõ¥Êñ∞Êó∂Ôºå‰∏çÈúÄË¶ÅÈ´ò‰∫ÆÊ†áËÆ∞
        document.getElementById('community-cards').innerHTML = this.communityCards.map(c => this.createCardHtml(c)).join('');

        this.players.forEach(p => {
            let el = document.getElementById(`p${p.id}`);
            el.querySelector('.chips').textContent = p.chips;
            
            let statusText = '';
            if (p.status === 'folded') statusText = 'Fold';
            else if (p.status === 'eliminated') statusText = 'Out';
            else if (p.status === 'allin') statusText = 'All-in';
            else if (p.currentBet > 0) statusText = `$${p.currentBet}`;
            
            el.querySelector('.status').textContent = statusText;
            el.querySelector('.dealer-btn').style.display = (this.dealerIdx === p.id) ? 'flex' : 'none';

            if (p.hand.length > 0) {
                let showFace = (p.isHuman || this.stage === 'showdown');
                this.renderCards(p.id, p.hand, showFace);
            } else {
                el.querySelector('.player-cards').innerHTML = '';
            }
            
            if (p.status === 'folded') el.querySelector('.player-cards').classList.add('folded');
            else el.querySelector('.player-cards').classList.remove('folded');
            if (p.isEliminated) el.style.opacity = 0.3;
        });
    }

    renderCards(pid, cards, showFace) {
        let html = '';
        if (showFace) html = cards.map(c => this.createCardHtml(c)).join('');
        else html = `<div class="card back"></div><div class="card back"></div>`;
        document.getElementById(`p${pid}`).querySelector('.player-cards').innerHTML = html;
    }

    // Êñ∞Â¢ûÔºöisHighlighted ÂèÇÊï∞
    createCardHtml(card, isHighlighted = false) {
        let cls = `card ${card.color} ${isHighlighted ? 'winning-card' : ''}`;
        return `<div class="${cls}">${card.suit}<br>${card.rank}</div>`;
    }

    updateControls() {
        let p = this.players[0];
        let callAmt = this.highestBet - p.currentBet;
        document.getElementById('btn-fold').disabled = false;
        document.getElementById('btn-call').disabled = false;
        document.getElementById('btn-raise').disabled = (p.chips <= callAmt) || (this.raisesInRound >= 4);
        document.getElementById('btn-call').textContent = (callAmt === 0) ? "ËøáÁâå" : `Ë∑üÊ≥® (${callAmt})`;
    }

    disableControls(disabled) {
        document.getElementById('btn-fold').disabled = disabled;
        document.getElementById('btn-call').disabled = disabled;
        document.getElementById('btn-raise').disabled = disabled;
    }
}

const game = new PokerGame();
</script>
</body>
</html>